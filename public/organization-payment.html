<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <link rel="icon" type="x-icon" href="img/logo.png">
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>ORGANIZATION - PAYMENTS</title>
       <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css">
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.print.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
      
        
        
    </head>
<style>
    table.dataTable.no-footer{
        border-bottom: 1px solid #e9e7e7 !important;
    }
    .dataTables_wrapper{
        border-bottom: 1px solid #919191;
    }
       .export-container {
    position: absolute;
    right: 0;
    top: 0;
    z-index: 1;
}

.export-dropdown {
    position: relative;
    display: inline-block;
}

.export-btn {
    background-color: #1B3A28;
    color: #ffffff;
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);

}

.export-btn:hover {
    background-color: #3e865c;
}

.export-content {
    display: none;
    position: absolute;
    background-color: #fff;
    min-width: 83px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    z-index: 1;
}

.export-content a {
    color: #333;
    padding: 8px 16px;
    text-decoration: none;
    display: block;
    font-size: 14px;
    border-bottom: 1px solid #eee;
}

.export-content a:hover {
    background-color: #f8f9fa;
}

.export-dropdown:hover .export-content {
    display: block;
}
@media print {
    body {
        font-family: Arial, sans-serif;
        font-size: 12px;
    }

    .export-container, .dataTables_wrapper .top, .dataTables_wrapper .bottom {
        display: none;
    }

    .custom-table {
        border-collapse: collapse;
        width: 100%;
    }

    .custom-table th, .custom-table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #ddd;
    }

    .custom-table thead {
        background-color: #f1f1f1;
    }
}
        .table-container{
            width: auto;
            background-color: white;
            padding-top: 20px;
            padding-left: 10px;
            padding-right: 10px;   
            border-radius: 3px;
            padding-bottom: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
.dataTables_scroll {
    border-radius: 5px 5px 0 0; /* 5px top border radius */
}

.dataTables_scrollBody {
    border-radius: 0; /* Ensure no bottom border radius */
}



.custom-table thead th:first-child {
    border-top-left-radius: 5px; /* Adjusted to 5px */
}

.custom-table thead th:last-child {
    border-top-right-radius: 5px; /* Adjusted to 5px */
}

/* Ensure no bottom border-radius */
.custom-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 0;
}

.custom-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 0;
}

.custom-table tbody tr td {
    border-bottom: 1px solid #e0e0e0 !important; /* Light gray border */
    padding: 12px 16px; /* Comfortable spacing */
    transition: background-color 0.2s ease; /* Smooth hover effect */
}

.custom-table tbody tr:last-child td {
    border-bottom: none !important; /* Remove border from last row */
}

/* Optional hover effect */
.custom-table tbody tr:hover td {
    background-color: #f8f9fa !important; /* Very subtle hover background */
    border-bottom-color: #d0d0d0 !important; /* Slightly darker border on hover */
}
.dataTables_wrapper .bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 30px;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        float: none !important;
        margin: 0 !important;
    }

    .dataTables_wrapper .dataTables_paginate {
        justify-self: flex-end;
    }

    /* Optional: Adjust spacing between elements */
    .dataTables_wrapper .dataTables_length {
        margin-right: 15px;
    }
   
    .dataTables_wrapper .dataTables_info {
        margin: 0 15px;
    }
    .dataTables_wrapper .top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_info,
.dataTables_wrapper .dataTables_paginate {
    display: flex;
    align-items: center;
}

.dataTables_wrapper .dataTables_length {
    margin-right: 15px;
    font-size: 14px;
}

.dataTables_wrapper .dataTables_length select {
    padding: 5px 12px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background-color: #fff;
    font-size: 14px;
}

.dataTables_wrapper .dataTables_info {
    font-size: 14px;
    color: #555;
}

.dataTables_wrapper .dataTables_paginate {
    font-size: 14px;
    color: #555;
}

.dataTables_wrapper .dataTables_paginate a {
    padding: 5px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    margin-left: 5px;
    text-decoration: none;
    color: #555;
    background-color: #f9f9f9;
}

.dataTables_wrapper .dataTables_paginate a:hover {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}

/* Styling the search box */
.dataTables_wrapper .dataTables_filter {
    display: flex;
    align-items: center;
    font-size: 14px;
}

.dataTables_wrapper .dataTables_filter label {
    margin-right: 10px;
}

.dataTables_wrapper .dataTables_filter input {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 14px;
}

/* Custom table design */
.custom-table {
    border-collapse: separate;
    border-spacing: 0;
    border-left: 1px solid #e0e0e0; /* Soft gray border on the left */
    border-right: 1px solid #e0e0e0; /* Soft gray border on the right */
    margin-bottom: 50px;
}

.custom-table thead th:first-child {
    border-top-left-radius: 5px;
}

.custom-table thead th:last-child {
    border-top-right-radius: 5px;
}

.custom-table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 0;
}

.custom-table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 0;
}

.custom-table tbody tr td {
    border-bottom: 1px solid #e0e0e0 !important;
    padding: 12px 16px;
    transition: background-color 0.2s ease;
}

.custom-table tbody tr:last-child td {
    border-bottom: none !important;
}

.custom-table tbody tr:hover td {
    background-color: #f8f9fa !important;
    border-bottom-color: #d0d0d0 !important;
}



.no-payment-message {
        text-align: center;  /* Centers the text */
          /* Set the text color */
        padding: 10px;  /* Optional padding for better readability */
        border-radius: 5px;  /* Optional rounded corners */
        font-size: 18px;  /* Optional font size */
        margin: 20px auto;  /* Optional margin for centering */
          /* Makes the div fit the content */
    }
.ellipsis-btn {
    font-size: 24px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    color: #007bff;
    transition: color 0.2s;
}

.ellipsis-btn:hover {
    color: #0056b3;
}

.details-container {
    text-align: center;
    margin-top: 10px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

    .qrcode-img {
    width: 150px;
    height: 150px;
    object-fit: contain;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 5px;
    background-color: #fff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 10px auto;
    transition: transform 0.3s ease;
}

.qrcode-img:hover {
    transform: scale(1.1);
    border-color: #007bff;
}
.status-balance {
        color: rgb(255, 0, 255);
        font-weight: bold;
    }

    .status-pending {
        color: orange;
        font-weight: bold;
    }
    .status-Decline{
        color: rgb(212, 7, 7);
        font-weight: bold;
    }

    .status-paid {
        color: green;
        font-weight: bold;
    }

    @keyframes colorAnimation {
    0% {
        color: rgb(0, 128, 255); /* Start with a blue color */
    }
    50% {
        color: rgb(0, 204, 255); /* Transition to an orange color */
    }
    100% {
        color: rgb(0, 128, 255); /* Transition back to blue */
    }
}

.status-processing {
    font-weight: light;
    animation: colorAnimation 2s infinite; /* Run the animation infinitely with a duration of 2 seconds */
}

        .error {
            color: red;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1045; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
  
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }/* Styles for the payment form */
#paymentForm {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 500px; /* Adjust as needed */
    margin: 0 auto; /* Center the form */
    padding: 20px;
    background-color: rgb(221, 231, 221);
    border-radius: 8px;
    padding-top: 10px;   
}

#paymentForm label {
    font-size: 16px;
    margin-bottom: 8px;
    color: #333;
}

#paymentForm input[type="text"],
#paymentForm input[type="number"] {
    font-size: 16px;
    padding: 8px;
    margin-bottom: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100%;
}

#paymentForm input[type="text"] {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

#paymentForm input[type="number"] {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

#paymentForm button {
    background-color: #007bff;
    color: white;
    font-size: 16px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 30%;
    justify-content: center;
}

#paymentForm button:hover {
    background-color: #0056b3;
}


#userResults {
    max-height: 125px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    margin-top: 8px;
    padding: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}


.user-item {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.user-item:hover {
    background-color: #f0f0f0;
}


#errorMessages {
    color: red;
    margin-top: 10px;
}
#transactions-container {
    max-height: 100px; /* Adjust the height as needed */
    overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
    }
 

  
</style>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark d-flex align-items-center justify-content-between px-3">
            <!-- Left Section -->
            <div class="d-flex align-items-center">
                <!-- Sidebar Toggle -->
                <button class="btn btn-link btn-sm me-3" id="sidebarToggle">
                    <i class="fas fa-bars" style="color: rgb(255, 255, 255);"></i>
                </button>
        
                <!-- Logo -->
                
                <div class="logo me-2">
                    <label for="logoUpload">
                        <div id="loadingIconLogo" class="logo-loading-container1">
                            <div class="spinnerlogo1"></div>
                        </div>
                        <img id="organizationLogo" src="" alt="Logo" height="40" style="cursor: pointer;">
                    </label>
                    <input type="file" id="logoUpload" style="display: none;" accept="image/*">
                    <div id="uploadingMessage">Uploading logo...</div>
                </div>
        
                <!-- Organization Info -->
                <div id="organizationInfo" class="d-flex flex-grow-1">
                    <!-- Organization Name will be inserted here -->
                </div>
            
           
            </div>
        
            <!-- Right Section -->
            <div class="d-flex align-items-center">
              
                <i id="profile-item" class="dropdown-item me-3">
                    <a href="#" style="color: #25330f; text-decoration: none;">Loading...</a>
                </i>
        
                <!-- User Dropdown -->
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-decoration-none" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle fa-2x" style="color: #ffffff;"></i>
                        <i class="fas fa-caret-down ms-2" style="color: #ffffff;"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end custom-dropdown" aria-labelledby="userDropdown" style="
                        width: 110px !important; 
                        min-width: 110px !important; 
                        background-color: #ffffff; 
                        border: 1px solid #ccc; 
                        border-radius: 8px; 
                        height: auto;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
                        padding: 0;">
                        <li>
                            <a class="dropdown-item" href="#" id="logout" style="
                                display: flex; 
                                align-items: center; 
                                padding: 10px; 
                                text-decoration: none; 
                                font-size: 15px; 
                                font-weight: 600; 
                                color: #343a40; 
                                height: auto;
                                border-bottom: 1px solid #ddd; 
                                transition: background-color 0.3s, color 0.3s;"
                                onmouseover="this.style.backgroundColor='rgb(221, 231, 221)'; this.style.color='black';"
                                onmouseout="this.style.backgroundColor='transparent'; this.style.color='#343a40';">
                                <i class="fas fa-sign-out-alt" style="margin-right: 8px; color: inherit;"></i> Sign Out
                            </a>
                            <a class="dropdown-item" href="#" id="logouts" style="
                                display: flex; 
                                align-items: center; 
                                padding: 10px; 
                                text-decoration: none; 
                                font-size: 15px; 
                                font-weight: 600; 
                                color: #343a40; 
                                height: auto;
                                transition: background-color 0.3s, color 0.3s;"
                                onmouseover="this.style.backgroundColor='rgb(221, 231, 221)'; this.style.color='black';"
                                onmouseout="this.style.backgroundColor='transparent'; this.style.color='#343a40';">
                                <i class="fas fa-exchange-alt" style="margin-right: 8px; color: inherit;"></i> Switch
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
                <script>
                   document.getElementById('logouts').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default link behavior
        
            // SweetAlert confirmation
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to switch account?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745', // Green confirm button
                cancelButtonColor: '#dc3545', // Red cancel button
                confirmButtonText: 'Yes, Switch Account!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Switch Account',
                        text: 'Choose your organization',
                        icon: 'success',
                        timer: 3000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'chooseorganizations.html'; // Redirect to choose organizations page
                    });
                }
            });
        });
        function fetchOrganizationData() {
    const token = localStorage.getItem('token'); // Retrieve token from storage
    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch('https://finalccspayment.onrender.com/api/auth/organization/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.name) {
            
            const infoDiv = document.getElementById('organizationInfo');
            infoDiv.innerHTML = `
              <div class="custom-heading">${data.name}</div>

       
              
            `;
        } else {
            document.getElementById('organizationInfo').innerText = 'No organization data found.';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('errorMessages').innerText = 'An error occurred. Please try again.';
    });
}


document.addEventListener('DOMContentLoaded', fetchOrganizationData);


   function fetchLoggedInUserDetails() {
    const token = localStorage.getItem('token'); // Retrieve the token from localStorage

    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch('https://finalccspayment.onrender.com/api/auth/organization-user/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(user => {
        if (!user) {
            throw new Error('User not found');
        }
        
        
        const fullName = `${user.firstname} ${user.lastname}`; 

        document.getElementById('profile-item').innerHTML = `
           <a style="color: white; text-decoration: none; " href="organization-users-info.html">
   
   <h3 style="color: white; text-decoration: none; font-size: 18px; margin-top:10px;">${user.firstname} ${user.lastname}</h3>
</a>



        `;
    })
    .catch(error => {
        console.error('Error fetching organization user details:', error);
        document.getElementById('profile-item').innerHTML = '<a href="#">Error loading profile</a>';
    });
}

// Call the function when the DOM is loaded
document.addEventListener('DOMContentLoaded', fetchLoggedInUserDetails);
    
            document.getElementById('logout').addEventListener('click', function(event) {
                event.preventDefault();
    
                Swal.fire({
                    title: 'Are you sure?',
                    text: "Do you want to log out?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: 'Yes, log out!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem('token');
                        Swal.fire({
                            title: 'Logged Out!',
                            text: 'You have been logged out successfully.',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = 'adminlogin.html';
                        });
                    }
                });
            });
        </script>
   
    


   <div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-light" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Overview</div>
                    <a class="nav-link" href="organization-dashboard.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Dashboard
                    </a>

                    <div class="sb-sidenav-menu-heading">Payment Management</div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePayments" aria-expanded="false" aria-controls="collapsePayments">
                        <div class="sb-nav-link-icon"><i class="fas fa-credit-card"></i></div>
                        Payments
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapsePayments" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                           
                            <a class="nav-link" href="organization-allpayments.html">Overview</a>
                            <a class="nav-link" href="organization-active-payment.html">Active Payment</a> 
                            <a class="nav-link" href="organization-addpayments.html">Add Payment</a>
                            <a class="nav-link" href="organization-reports.html">Reports</a> 
                        </nav>
                    </div>

                   

                    <a class="nav-link collapsed active" href="#" data-bs-toggle="collapse" data-bs-target="#collapseTransactions" aria-expanded="false" aria-controls="collapseTransactions">
                        <div class="sb-nav-link-icon"><i class="fas fa-exchange-alt"></i></div>
                        Transactions
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseTransactions" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="organization-alltransactions.html">Overview</a>
                            <a class="nav-link" href="organization-payment.html">Management</a>
                            <a class="nav-link" href="organization-masterlist.html">Masterlist</a>
                            <a class="nav-link" href="organization-transactionsreports.html">Reports</a>
                        </nav>
                    </div>


                    <div class="sb-sidenav-menu-heading">Organization Overview</div>
                    <a class="nav-link" href="organization-academic-list.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Academic List
                    </a>
                    <div class="sb-sidenav-menu-heading">Product Management</div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseProducts" aria-expanded="false" aria-controls="collapseProducts">
                        <div class="sb-nav-link-icon"><i class="fas fa-box"></i></div>
                        Products
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseProducts" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="organization-products.html">Management</a>
                            <a class="nav-link" href="organization-pre-order.html">Pre-Order</a>
                            <a class="nav-link" href="organization-gcashorder.html">Manage QR-Code</a>
                            <a class="nav-link" href="organization-allorderreports.html">QR-Code Reports</a>
                            <a class="nav-link" href="organization-addproduct.html">Add Product</a>
                        </nav>
                    </div>

                    <div class="sb-sidenav-menu-heading">Order Management</div>
                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseOrders" aria-expanded="false" aria-controls="collapseOrders">
                        <div class="sb-nav-link-icon"><i class="fas fa-shopping-cart"></i></div>
                        Orders
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseOrders" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="organization-orders.html">Transactions</a>
                            <a class="nav-link" href="organization-ordersManage.html">Paid Orders Handling</a>
                        </nav>
                    </div>

                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseOrderTransactions" aria-expanded="false" aria-controls="collapseOrderTransactions">
                        <div class="sb-nav-link-icon"><i class="fas fa-receipt"></i></div>
                        Transactions
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseOrderTransactions" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="organization-order-transaction.html">Overview</a>
                            <a class="nav-link" href="organization-order-transaction-reports.html">Reports</a>
                        </nav>
                    </div>

                    <div class="sb-sidenav-menu-heading">Transaction Summary</div>
                    <a class="nav-link" href="organization-transactions-summary.html">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Overview
                    </a>
                </div>
            </div>
        </nav>
    </div>


            
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-5"></h1>
                        
                        <div class="row">
                            <div class="col-xl-12">
                                <div class="card mb-4" style="padding: 20px;">
                                    <ol class="breadcrumb mb-4">
                                        <li class="breadcrumb-item" style="font-style: italic;">Payment</li>
                                        <li class="breadcrumb-item active" style="font-style: italic;">Transactions</li>
                                    </ol>
                                   <div class="d-flex justify-content-between align-items-center" style="margin-top: 20px; margin-bottom: 20px; padding-right: 20px;">
    <!-- Left-aligned search -->
    <div class="search-container d-flex align-items-center" style="margin-left: 10px;">
        <form class="form-inline" onsubmit="event.preventDefault();">
            <div class="input-group">
                <input class="form-control" type="search" placeholder="Search Semesters" aria-label="Search" id="searchInput" oninput="searchSemester()">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
            </div>
        </form>
    </div>

    

    <!-- Right-aligned Add Payment button and text, aligned vertically -->
</div>

                                    <div class="content">

                                        <div class="contents">     
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="transactionReportModal" class="modal" style="display: none;">
                                <div class="modal-content" style="width: 500px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                                  <h3 style="text-align: center; font-size: 24px; margin-bottom: 20px;">Report Transaction</h3>
                                  <span class="close" style="position: absolute; right: 20px; cursor: pointer;" onclick="closeReportModal()">&times;</span>
                                  
                                  <form id="transactionReportForm">
                                    <input type="hidden" id="reportTransactionId" name="transaction_id" />
                                    
                                    <label for="reason" style="font-weight: bold;">Reason:</label>
                                    <div style="margin-bottom: 15px;">
                                      <label><input type="radio" name="reason" value="Proof of payment is incorrect" required /> Proof of payment is incorrect</label><br />
                                      <label><input type="radio" name="reason" value="Photo blurred" /> Photo blurred</label><br />
                                      <label><input type="radio" name="reason" value="Inappropriate image" /> Inappropriate image</label><br />
                                      <!-- Add more reasons as needed -->
                                    </div>
                                    
                                    <label for="description" style="font-weight: bold;">Description (optional):</label>
                                    <textarea id="description" name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                                    
                                    <button type="submit" style="margin-top: 15px; background-color: #dc3545; color: white; border: none; border-radius: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer;">Submit Report</button>
                                  </form>
                                </div>
                              </div>
                              
                            
                               <div id="addAmountModal" class="modal" style="display: none;">
                                <div class="modal-content-gcash" style="width: 450px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                                    <h3 style="text-align: center; font-size: 24px; margin-bottom: 20px;">Add Amount for Transaction</h3>
                                    <span 
                                style="position: absolute; right: 20px; cursor: pointer; margin-top: 20px;" 
                                class="close" 
                                onclick="closeTransactionModal()">
                                <i class="fas fa-times-circle" style="font-size: 24px;"></i>
                            </span>
                            
                            
                                    <form id="addAmountForm" style="display: flex; flex-direction: column; gap: 15px;">
                                        <input type="hidden" id="transaction_id" name="transaction_id"/>
                            
                                        <label for="total_amount" style="font-size: 16px;">Total Amount:</label>
                                        <input 
                                            type="number" 
                                            id="total_amount" 
                                            name="total_amount" 
                                            required 
                                            style="padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; outline: none; transition: border-color 0.3s;">
                                        
                                            <button type="submit" class="btn-submit">Submit</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="modal fade" id="transactionHistoryModal" tabindex="-1" aria-labelledby="transactionHistoryModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-xl"> <!-- Changed to modal-xl for extra large -->
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="transactionHistoryModalLabel">User Transaction History</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body" id="transactionHistoryDetails">
                                            <!-- Content will be dynamically inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            
                            <div class="modal fade" id="gcashqrcodemodal" tabindex="-1" aria-labelledby="gcashQrModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="gcashQrModalLabel">GCash QR Code</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img id="gcashQrImage" class="img-fluid" alt="Gcash QR Code" style="max-width: 100%; max-height: 550px;" />                                        </div>
                                       
                                    </div>
                                </div>
                            </div>
                            <script>
document.addEventListener('DOMContentLoaded', () => {
    const gcashModal = document.getElementById('gcashqrcodemodal');


    // Event listener for when the GCash modal is hidden
    gcashModal.addEventListener('hidden.bs.modal', function () {
        // Remove the backdrop manually
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());

        // Re-enable scrolling (optional)
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
    });
});
document.addEventListener('DOMContentLoaded', () => {
    const gcashModal = document.getElementById('qrgcash-${tx.transaction_id}');
    

    // Event listener for when the GCash modal is hidden
    gcashModal.addEventListener('hidden.bs.modal', function () {
        // Remove the backdrop manually
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());

        // Re-enable scrolling (optional)
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
    });
});
                                 
                                 function openGcashQrModal(imageSrc) {
        // Set the source of the image dynamically
        document.getElementById('gcashQrImage').src = imageSrc;
        
        // Show the modal
        var myModal = new bootstrap.Modal(document.getElementById('gcashqrcodemodal'));
        myModal.show();
    }
                            
                            
                               
                            
                            
                            document.addEventListener('DOMContentLoaded', fetchOrganizationData);

                            function openTransactionModalHistory(transactionId, userFirstName, userLastName) {
    // Show the modal using Bootstrap 5's modal API
    var transactionHistoryModal = new bootstrap.Modal(document.getElementById('transactionHistoryModal'));
    transactionHistoryModal.show();

    // Fetch transaction history from the API
    fetch(`https://finalccspayment.onrender.com/api/auth/transaction-history/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            const historyDetails = document.getElementById('transactionHistoryDetails');
            historyDetails.innerHTML = ''; // Clear any previous content

            // Add the heading with transaction ID and user's name
            const heading = `<h5>Transaction History of ID: ${transactionId} (${userFirstName} ${userLastName})</h5>`;
            historyDetails.innerHTML += heading;

            data.forEach(tx => {
                const showPromissoryNote = tx.promissory_note && tx.promissory_note.trim() !== '';
                let statusColor;
                if (tx.payment_status === "Balance" || tx.payment_status === "Balance Gcash") {
                    statusColor = 'red';
                } else if (tx.payment_status === "Pending") {
                    statusColor = 'orange';
                } else if (tx.payment_status === "Paid") {
                    statusColor = 'green';
                } else {
                    statusColor = 'black';
                }

                const proofOfPayment = tx.payment_method === "Gcash" && tx.proof_of_payment ? `
                    <button 
                        onclick="openGcashQrModal('${tx.proof_of_payment}')" 
                        class="btn btn-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#gcashqrcodemodal"
                        style="background-color: #007bff; 
                               color: white; 
                               border: none; 
                               border-radius: 5px; 
                               width: 33px; 
                               height: 35px; 
                               display: flex; 
                               align-items: center; 
                               justify-content: center; 
                               cursor: pointer; 
                               transition: background-color 0.3s;" 
                        onmouseover="this.style.backgroundColor='#0056b3'" 
                        onmouseout="this.style.backgroundColor='#007bff'">
                        <i class="fas fa-qrcode" style="font-size: 20px;"></i>
                    </button>
                ` : tx.proof_of_payment || 'N/A';

                const detailTable = `
                    <div style="margin-bottom: 20px;">
                        <p style="margin-bottom: 10px;">${new Date(tx.created_at).toLocaleString()}</p>
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Payment Method</th>
                                    <th>Proof of Payment</th>
                                    <th>Total Amount</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Received by</th>
                                    <th>Action</th>
                                    ${showPromissoryNote ? '<th>Promissory Note</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${tx.payment_method}</td>
                                    <td>${proofOfPayment}</td>
                                    <td>₱ ${tx.total_amount}</td>
                                    <td>₱ ${tx.balance}</td>
                                    <td style="color: ${statusColor}; font-weight: light;">${tx.payment_status}</td>
                                    <td>${tx.received_firstname && tx.received_lastname ? `${tx.received_firstname} ${tx.received_lastname}` : 'There is no receiver'}</td>
                                    <td>${tx.action ? tx.action : 'N/A'}</td>
                                    ${showPromissoryNote ? `
                                        <td>
                                            <button 
                                                onclick="openLogsModal('${tx.transaction_id}')" 
                                                class="btn btn-secondary"
                                                style="background-color: #6c757d; 
                                                       color: white; 
                                                       border: none; 
                                                       border-radius: 5px; 
                                                       width: 33px; 
                                                       height: 35px; 
                                                       display: flex; 
                                                       align-items: center; 
                                                       justify-content: center; 
                                                       cursor: pointer; 
                                                       transition: background-color 0.3s;" 
                                                onmouseover="this.style.backgroundColor='#5a6268'" 
                                                onmouseout="this.style.backgroundColor='#6c757d'">
                                                <i class="fas fa-eye" style="font-size: 20px;"></i>
                                            </button>
                                            <div id="logsModal-${tx.transaction_id}" class="modallogs" style="display:none;">
                                                <div class="modal-contentlogs">
                                                    <span class="close" onclick="closeLogsModal('${tx.transaction_id}')">
                                                        <i class="fas fa-times-circle"></i>
                                                    </span>
                                                    <img src="${tx.promissory_note}" alt="Promissory Note" class="responsive-image" />
                                                </div>
                                            </div>
                                        </td>
                                    ` : ''}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                historyDetails.innerHTML += detailTable;
            });
        })
        .catch(error => console.error('Error fetching transaction history:', error));
}

function closeGcashQrModal() {
    document.getElementById('gcashqrcodemodal').style.display = 'none';
}

                            function openLogsModal(transactionId) {
                                const modal = document.getElementById(`logsModal-${transactionId}`);
                                if (modal) {
                                    modal.style.display = 'block';
                                }
                            }
                            
                            function closeLogsModal(transactionId) {
                                const modal = document.getElementById(`logsModal-${transactionId}`);
                                if (modal) {
                                    modal.style.display = 'none';
                                }
                            }
                            
                            // Optional: Close modal when clicking outside the modal content
                            window.onclick = function (event) {
                                const modals = document.getElementsByClassName('modallogs');
                                Array.from(modals).forEach(modal => {
                                    if (event.target === modal) {
                                        modal.style.display = 'none';
                                    }
                                });
                            };
                            
                            function openGcashModal(transactionId) {
                                document.getElementById(`qrgcash-${transactionId}`).style.display = 'block';
                            }
                            function closeGcashModal(transactionId) {
                                document.getElementById(`qrgcash-${transactionId}`).style.display = 'none';
                            }
                            function closeTransactionModalHistory() {
                                // Hide the modal
                                document.getElementById('transactionHistoryModal').style.display = 'none';
                            }
                            function openGcashModalLogs(transactionId) {
    const modal = document.getElementById(`gcash-log-modal-${transactionId}`);
    if (modal) {
        modal.classList.add('show-modal');
    }
}

                            
                            function closeGcashModalLogs(transactionId) {
                                const modal = document.getElementById(`gcash-log-modal-${transactionId}`);
                                if (modal) {
                                    modal.style.display = 'none';
                                }
                            }
                            </script>
                            <style>/* Modal container */
                                .modallogs {
                                    display: none; /* Hidden by default */
                                    position: fixed; /* Stay in place */
                                    z-index: 1045; /* On top */
                                    left: 0;
                                    top: 0;
                                    width: 100%;
                                    height: 100%;
                                    overflow: auto; /* Enable scroll if needed */
                                    background-color: rgba(0, 0, 0, 0.4); /* Black with opacity */
                                }
                                
                                /* Modal content */
                                .modal-contentlogs {
                                    background-color: #fefefe;
                                    margin: 15% auto; /* Centered */
                                    padding: 20px;
                                    border: 1px solid #888;
                                    width: 50%; /* Adjust modal width */
                                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
                                    border-radius: 10px;
                                }
                                
                                /* Close button */
                                .modal-contentlogs .close {
                                    color: #aaa;
                                    float: right;
                                    font-size: 28px;
                                    font-weight: bold;
                                    cursor: pointer;
                                }
                                
                                .modal-contentlogs .close:hover,
                                .modal-contentlogs .close:focus {
                                    color: black;
                                    text-decoration: none;
                                    cursor: pointer;
                                }
                            
                                </style>
                            <div id="transactionModal" class="modal" style="display: none;">
                                <div class="modal-content-balance" style="background-color: rgb(221, 231, 221); border-radius: 10px; padding: 20px; width: 400px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;">
                                   <!-- Close Button -->
                                    <span style="margin-top: 18px;" class="close" onclick="closeTransactionModals()">
                                        <i class="fas fa-times-circle"></i>
                                    </span>
                                    
                                    <!-- Modal Title -->
                                    <h2 style="text-align: center; margin-bottom: 20px; font-size: 30px; color: #333;">Pay Balance</h2>
                                    
                                    <!-- Current Balance -->
                                    <p id="currentBalance" style="text-align: center; font-size: 16px; color: #666; margin-bottom: 20px;">Current Balance: </p>
                                    
                                    <!-- Additional Amount -->
                                    <label for="additionalAmount" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Additional Amount:</label>
                                    <input type="number" id="additionalAmount" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px;">
                                    
                                    <!-- Payment Method -->
                                   
                                    <select id="payment_method" style="display: none;">
                                        <option value="Gcash">Gcash</option>
                                        
                                      
                                        
                                    </select>
                            
                                    <!-- Error Message -->
                                    <p id="error-message" class="error" style="color: red; font-size: 14px; text-align: center; display: none;">Error message</p>
                                    
                                    <!-- Pay Balance Button -->
                                    <div class="text-center" style="margin-top: 20px;">
                                        <button onclick="updatePayment()" class="btn btn-success" style="background-color: #198754; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                                            Pay Balance
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="transactionModalPending" class="modal" style="display: none;">
                                <div class="modal-content-balance" style="background-color: rgb(221, 231, 221); border-radius: 10px; padding: 20px; width: 400px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative;">
                                   <!-- Close Button -->
                                    <span style="margin-top: 18px;" class="close" onclick="closeTransactionModalPending()">
                                        <i class="fas fa-times-circle"></i>
                                    </span>
                                    
                                    <!-- Modal Title -->
                                    <h2 style="text-align: center; margin-bottom: 20px; font-size: 30px; color: #333;">Pay Balance</h2>
                                    
                                    <!-- Current Balance -->
                                    <p id="currentBalancePending" style="text-align: center; font-size: 16px; color: #666; margin-bottom: 20px;">Current Balance: </p>
                                    
                                    <!-- Additional Amount -->
                                    <label for="additionalAmountPending" style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Additional Amount:</label>
                                    <input type="number" id="additionalAmountPending" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px;">
                                    
                                    <!-- Payment Method -->
                                   
                                    <select id="payment_method_pending" style="display: none;">
                                        <option value="Cash">Cash</option>
                                      
                                    </select>
                            
                                    <!-- Error Message -->
                                    <p id="error-message-pending" class="error" style="color: red; font-size: 14px; text-align: center; display: none;">Error message</p>
                                    
                                    <!-- Pay Balance Button -->
                                    <div class="text-center" style="margin-top: 20px;">
                                        <button onclick="updatePaymentPending()" class="btn btn-success" style="background-color: #198754; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                                            Pay Balance
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <script>
                            function openTransactionModal(transactionId, balance) {
                                document.getElementById('transactionModal').style.display = 'block';
                                document.getElementById('currentBalance').innerText = `Current Balance: ${balance}`;
                                document.getElementById('transactionModal').dataset.transactionId = transactionId;
                            }
                            
                            function closeTransactionModals() {
                                document.getElementById('transactionModal').style.display = 'none';
                                document.getElementById('error-message').innerText = '';
                            }
                            
                            function openTransactionModalPending(transactionId, balance) {
                                document.getElementById('transactionModalPending').style.display = 'block';
                                document.getElementById('currentBalancePending').innerText = `Current Balance: ${balance}`;
                                document.getElementById('transactionModalPending').dataset.transactionId = transactionId;
                            }
                            
                            function closeTransactionModalPending() {
                                document.getElementById('transactionModalPending').style.display = 'none';
                                document.getElementById('error-message-pending').innerText = '';
                            }
                            
                            async function updatePayment() {
    const transactionId = document.getElementById('transactionModal').dataset.transactionId;
    const additionalAmount = parseFloat(document.getElementById('additionalAmount').value);
    const paymentMethod = document.getElementById('payment_method').value;

    if (isNaN(additionalAmount) || additionalAmount <= 0) {
        Swal.fire({
            icon: 'error',
            title: 'Invalid Input',
            text: 'Additional amount must be greater than zero.'
        });
        return;
    }

    const result = await Swal.fire({
        title: 'Confirm Payment Update',
        text: `Are you sure you want to add ₱${additionalAmount} to this payment?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: 'red',
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'No, cancel'
    });

    if (!result.isConfirmed) return;

    try {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'adminlogin.html';
            return;
        }

        // **Show loading message before fetch**
        Swal.fire({
            title: 'Updating Payment...',
            text: 'Please wait while the payment is being processed.',
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch('https://finalccspayment.onrender.com/api/auth/update-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ transactionId, additionalAmount, payment_method: paymentMethod }),
        });

        const responseResult = await response.json();

        Swal.close(); // Close loading message after fetch response

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: responseResult.message
            }).then(() => {
                document.getElementById('transactionModal').reset();
                closeTransactionModals();
                fetchTransactionsByPaymentId(paymentId);
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: responseResult.message
            });
        }
    } catch (error) {
        console.error('Error updating payment:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while updating the payment.'
        });
    }
}

                            
async function updatePaymentPending() {
    const transactionId = document.getElementById('transactionModalPending').dataset.transactionId;
    const additionalAmount = parseFloat(document.getElementById('additionalAmountPending').value);
    const paymentMethod = document.getElementById('payment_method_pending').value;

    if (isNaN(additionalAmount) || additionalAmount <= 0) {
        Swal.fire({
            icon: 'error',
            title: 'Invalid Input',
            text: 'Additional amount must be greater than zero.'
        });
        return;
    }

    const result = await Swal.fire({
        title: 'Confirm Payment Update',
        text: `Are you sure you want to add ₱${additionalAmount} to this payment?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: 'red',
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'No, cancel'
    });

    if (!result.isConfirmed) return;

    try {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'adminlogin.html';
            return;
        }

        // **Show loading message before fetch**
        Swal.fire({
            title: 'Updating Payment...',
            text: 'Please wait while the payment is being processed.',
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch('https://finalccspayment.onrender.com/api/auth/update-paymentPending', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ transactionId, additionalAmount, payment_method: paymentMethod }),
        });

        const responseResult = await response.json();

        Swal.close(); // Close loading message after fetch response

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: responseResult.message
            }).then(() => {
                document.getElementById('transactionModalPending').reset();
                closeTransactionModalPending();
                fetchTransactionsByPaymentId(paymentId);
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: responseResult.message
            });
        }
    } catch (error) {
        console.error('Error updating payment:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while updating the payment.'
        });
    }
}

                            
                            // Close the modal when clicking outside of it
                            window.onclick = function(event) {
                                const modal = document.getElementById('transactionModal');
                                if (event.target == modal) {
                                    closeTransactionModals();
                                }
                                const modalPending = document.getElementById('transactionModalPending');
                                if (event.target == modalPending) {
                                    closeTransactionModalPending();
                                }
                            }
                            </script>
                           
                                <!-- "for 1 transactions"  <div style="text-align: right;">
                                                    ${payment.status === 'Accepted' ? `
                                                        <button class="btn btn-success" onclick="openPaymentModal('${payment.id}')">+</button>
                                                        <div style="font-size: 10px; font-weight: bold;">Pay now!</div>
                                                    ` : ''}
                                                </div> -->
                                <div id="paymentModal" class="modal">
                                  
                                  
                                    <div class="modal-content-payment">
                               
                                        <div>
                                        <form id="paymentForm">
                                            <span style="position: absolute; right: 20px; cursor: pointer; margin-top: 20px;" class="close" onclick="closeModal() ">
                                                <i class="fas fa-times-circle"></i>
                                            </span>
                                            
                                            <h2 style="text-align: center;">Add Payment</h2>
                                            <label style="font-weight: bold;">User:</label>
                                         
                                            <input type="text" id="userSearch" name="userSearch" placeholder="Search user by name or id number" required>
                                            <div id="userResults" style="display: none;"></div>
                                        
                                            <label for="totalAmount" style="font-weight: bold;">Total Amount:</label>
                                            <input type="number" id="totalAmount" name="totalAmount" required><br><br>
                                        
                                            <input type="hidden" id="paymentId" name="paymentId">
                                            <input type="hidden" id="userId" name="userId">
                                            <div class="text-center">
                                            <button type="submit" class="btn btn-success">Submit</button>
                                            </div>
                                        </form>
                                        
                                        </div>
                                        
                                        
                                        
                                        <div id="formError" class="error"></div>
                                        
                                        <div id="formError" class="error"></div>
                                    </div>
                                </div>

  
 <!-- Modal -->
<div class="modal fade" id="paymentModalAll" tabindex="-1" aria-labelledby="paymentModalAllLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 35%;">
      <div class="modal-content">
        
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalAllLabel" style="text-align: center; font-size: 24px; color: #333;">Add Transaction For All</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <form id="paymentFormAll">
          <div class="modal-body">
            
            <label class="label" style="font-weight: bold; display: block; margin-bottom: 5px; color: #555;">User:</label>
            <input type="hidden" id="userIdAll" name="userIdAll">
            <input type="text" id="userSearchAll" name="userSearchAll" placeholder="Search user by name or ID number" required class="form-control mb-3">
            <div id="userResultsAll" class="search-results mb-3" style="padding: 10px; border: 1px solid #ddd;"></div>
  
            <label class="label" style="font-weight: bold; margin-bottom: 5px; color: #555; display: none;">List of Payments:</label>
            <div id="paymentListContainerAll" style="text-align: center;"></div>
  
            <div class="text-center">
              <h4 style="font-size: 18px; color: #333;">Total Amount: ₱<span id="totalAmountDisplayAll">0.00</span></h4>
            </div>
          </div>
  
          <div id="formErrorAll" class="error" style="color: red; margin-top: 10px;"></div>
          <input type="hidden" id="semesterIdAll" name="semesterIdAll">
  
          <!-- Modal footer with Submit button -->
          <div class="modal-footer" style="padding: 10px;">
            <button type="submit" class="btn-submit" style="font-size: 16px;">Submit</button>
          </div>
  
        </form>
  
      </div>
    </div>
  </div>
  
  <script>
    // Reset the search input field when the modal is closed
    var paymentModalAll = document.getElementById('paymentModalAll');
    paymentModalAll.addEventListener('hidden.bs.modal', function () {
      document.getElementById('userSearchAll').value = ''; // Clear the search input
      document.getElementById('userResultsAll').innerHTML = '';
      document.getElementById('paymentListContainerAll').innerHTML = ''; // Clear the search results
    });
  </script>
  
  
  
                                
                                <script>
                                

// Update total amount dynamically
function updateTotalAmountAll() {
    let total = 0;
    document.querySelectorAll('input[name="paymentCheckboxAll"]:checked').forEach(cb => {
        total += parseFloat(cb.amountInput.value) || 0;
    });
    document.getElementById('totalAmountDisplayAll').innerText = total.toFixed(2);
}

// Open Payment Modal and pass semester ID
function openPaymentModalAll(button) {
    const semesterId = button.getAttribute('data-semester-id'); // Retrieve semester ID
    document.getElementById('semesterIdAll').value = semesterId; // Store semester ID
    showModalAll(); // Open the modal
}

// Fetch payments filtered by user and semester
function fetchFilteredPaymentsByUser() {
    const userId = document.getElementById('userIdAll').value;
    const semesterId = document.getElementById('semesterIdAll').value; // Get semester ID
    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = 'adminlogin.html';
        return;
    }

    fetch('https://finalccspayment.onrender.com/api/auth/payments/filtered-by-user', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId, semesterId }) // Send semester ID and user ID
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('paymentListContainerAll');
        container.innerHTML = '';

        if (!data || data.error) {
            let message = data.error === 'User is not enrolled in this semester.' 
                ? '<p style="color: red; font-weight: bold;">User is not enrolled in this semester.</p>' 
                : '<p style="color: green; font-weight: bold;">You already paid all payments for this semester.</p>';
            
            container.innerHTML = message;
            return;
        }

        // Display payments
        data.forEach(payment => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.style.marginBottom = '10px';

            // Apply color only to payment_type
            let paymentTypeColor = 'black'; // Default color
            if (payment.payment_type === 'Mandatory') {
                paymentTypeColor = 'green';
            } else if (payment.payment_type === 'Not mandatory') {
                paymentTypeColor = '#3366cc';
            } else if (payment.payment_type === 'Other fees') {
                paymentTypeColor = 'gold';
            }

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input';
            checkbox.name = 'paymentCheckboxAll';
            checkbox.value = payment.id;
            checkbox.dataset.defaultAmount = payment.price;
            checkbox.id = `paymentAll-${payment.id}`;

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = checkbox.id;
            label.style.marginRight = '10px';
            label.innerHTML = `${payment.name} - ₱${payment.price} <span style="color: ${paymentTypeColor}; font-weight: bold;">(${payment.payment_type})</span>`;

            const amountInput = document.createElement('input');
amountInput.type = 'number';
amountInput.className = 'form-control payment-amount-input';
amountInput.style.display = 'block'; // Change from 'none' to 'block' so it takes up space
amountInput.style.margin = '0 auto'; // Centers the element horizontally
amountInput.style.width = '150px';
amountInput.style.marginTop = '5px';
amountInput.min = '0';
amountInput.max = payment.price;
amountInput.value = payment.price;

            checkbox.amountInput = amountInput;
            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    amountInput.style.display = 'block';
                    amountInput.value = this.dataset.defaultAmount;
                } else {
                    amountInput.style.display = 'none';
                    amountInput.value = '';
                }
                updateTotalAmountAll();
            });

            amountInput.addEventListener('input', function () {
                if (parseFloat(this.value) > parseFloat(this.max)) {
                    this.value = this.max;
                }
                updateTotalAmountAll();
            });

            div.appendChild(checkbox);
            div.appendChild(label);
            div.appendChild(amountInput);
            container.appendChild(div);
        });
    })
    .catch(error => {
        console.error('Error fetching filtered payments:', error);
        document.getElementById('paymentListContainerAll').innerHTML =
            '<p style="color: red; font-weight: bold;">An error occurred while retrieving payments.</p>';
    });
}



// Fetch users
function fetchUsersAll(query) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'adminlogin.html';
        return;
    }

    fetch(`https://finalccspayment.onrender.com/api/auth/userspaymentorg?search=${query}`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => response.json())
    .then(data => {
        const userResults = document.getElementById('userResultsAll');
        userResults.innerHTML = ''; // Clear previous results

        if (data.length === 0) {
            userResults.innerHTML = '<p>No users found</p>';
            return;
        }

        // Convert query to lowercase for case-insensitive search
        const queryLower = query.toLowerCase();

        const filteredUsers = data.filter(user => 
            (user.firstname && user.firstname.toLowerCase().includes(queryLower)) ||
            (user.middlename && user.middlename.toLowerCase().includes(queryLower)) ||
            (user.lastname && user.lastname.toLowerCase().includes(queryLower)) ||
            (user.idnumber && user.idnumber.toLowerCase().includes(queryLower)) ||
            (user.email && user.email.toLowerCase().includes(queryLower))
        );

        if (filteredUsers.length === 0) {
            userResults.innerHTML = '<p>No users match your search.</p>';
            return;
        }

        // Append matching users to the results list
        filteredUsers.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.classList.add('user-item');
            userDiv.innerHTML = `<p>${user.lastname} ${user.firstname} ${user.middlename || ''} (${user.idnumber})</p>`;
            
            // Ensure userIdAll is set when clicking
            userDiv.addEventListener('click', () => {
                selectUserAll(user.id, user.lastname, user.firstname, user.middlename);
            });

            userResults.appendChild(userDiv);
        });
    })
    .catch(error => console.error('Error fetching users:', error));
}

// Ensure user ID is set when selecting a user
function selectUserAll(userId, lastname, firstname, middlename) {
    document.getElementById('userIdAll').value = userId;  // Set the hidden userId input
    document.getElementById('userSearchAll').value = `${lastname} ${firstname} ${middlename || ''}`;
    document.getElementById('userResultsAll').innerHTML = ''; // Clear results

    // Fetch payments after user is selected
    fetchFilteredPaymentsByUser();
}

// Listen for user input in the search box and call `fetchUsersAll`
document.getElementById('userSearchAll').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length > 0) {
        fetchUsersAll(query);
    } else {
        document.getElementById('userResultsAll').innerHTML = '';
    }
});



document.getElementById('paymentFormAll').addEventListener('submit', function(event) {
  event.preventDefault();
  const userId = document.getElementById('userIdAll').value;
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'adminlogin.html';
    return;
  }
  
  // Gather all selected payments and their amount inputs
  const checkboxes = document.getElementsByName('paymentCheckboxAll');
  const selectedPayments = [];
  checkboxes.forEach(cb => {
    if (cb.checked) {
      const paymentId = cb.value;
      const totalAmount = cb.amountInput.value;
      if (totalAmount && parseFloat(totalAmount) > 0) {
        selectedPayments.push({ paymentId, totalAmount });
      }
    }
  });
  
  if (selectedPayments.length === 0) {
    Swal.fire({
      icon: 'error',
      title: 'No Payment Selected',
      text: 'Please select at least one payment and enter a valid amount.'
    });
    return;
  }
  
  Swal.fire({
    title: 'Confirm Payment',
    text: "Are you sure you want to add these payments?",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#28a745',
    cancelButtonColor: 'red',
    confirmButtonText: 'Yes, add it!',
    cancelButtonText: 'No, cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Processing...',
        text: 'Please wait while the payments are being processed.',
        icon: 'info',
        showConfirmButton: false,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      fetch(`https://finalccspayment.onrender.com/api/auth/payments/insert-multiple`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ userId, payments: selectedPayments })
      })
        .then(response => response.json())
        .then(data => {
          Swal.close();
          // Build a list of results from the returned data
          let htmlResult = '<ul style="text-align:left;">';
data.results.forEach(r => {
  if (r.status === 'success') {
    htmlResult += `<li style="color:green;">Success ${r.paymentName} payment with a Transaction ID: ${r.transactionId}</li>`;
  } else {
    htmlResult += `<li style="color:red;">${r.paymentName} payment have ${r.message}</li>`;
  }
});
htmlResult += '</ul>';
Swal.fire({
  title: 'Payment Results',
  html: htmlResult,
  icon: 'info'

          }).then(() => {
            document.getElementById('paymentFormAll').reset();
            closeModalAll();
            fetchTransactionsByPaymentId(paymentId);
          });
        })
        .catch(error => {
          Swal.close();
          console.error('Error adding payments:', error);
          Swal.fire({
            title: 'Error',
            text: 'An error occurred while adding the payments. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        });
    }
  });
});
function closeModalAll() {
    var paymentModalAll = document.getElementById('paymentModalAll');
    var modalInstance = bootstrap.Modal.getInstance(paymentModalAll);

    if (modalInstance) {
        modalInstance.hide(); // Properly hide the modal using Bootstrap
    }

    // Ensure modal is fully removed from the DOM
    setTimeout(() => {
        document.body.classList.remove('modal-open'); // Remove Bootstrap's body class
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove()); // Remove any remaining backdrops
    }, 300);

    // Clear all inputs when modal is closed
    document.getElementById('userIdAll').value = '';
    document.getElementById('userSearchAll').value = '';
    document.getElementById('semesterIdAll').value = ''; // Clear semester ID
    document.getElementById('userResultsAll').innerHTML = '';
    document.getElementById('paymentListContainerAll').innerHTML = '';
    document.getElementById('totalAmountDisplayAll').innerText = '0.00'; // Reset total amount
}
                           
                                
                                    function showModal() {
                                        document.getElementById('paymentModal').style.display = 'block';
                                    }
                                
                                    function closeModal() {
                                        document.getElementById('paymentModal').style.display = 'none';
                                    }
                                
                                    function fetchUsers(query) {
                                        const token = localStorage.getItem('token');
                                        if (!token) {
                                            window.location.href = 'adminlogin.html';
                                            return;
                                        }
                                
                                        fetch(`https://finalccspayment.onrender.com/api/auth/userspaymentorg?search=${query}`, {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        })
                                        .then(response => {
                                            if (!response.ok) {
                                                throw new Error('Failed to fetch users');
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            const userResults = document.getElementById('userResults');
                                            userResults.innerHTML = ''; // Clear previous results
                                
                                            if (data.length === 0) {
                                                userResults.innerHTML = '<p>No users found</p>';
                                                return;
                                            }
                                
                                            data.forEach(user => {
                                                if (user.username.toLowerCase().startsWith(query.toLowerCase()) || user.idnumber.toLowerCase().startsWith(query.toLowerCase()) || user.firstname.toLowerCase().startsWith(query.toLowerCase()) || user.lastname.toLowerCase().startsWith(query.toLowerCase()) ||
                                                user.email.toLowerCase().startsWith(query.toLowerCase())) {
                                                    const userDiv = document.createElement('div');
                                                    userDiv.classList.add('user-item');
                                                    userDiv.innerHTML = `<p>${user.lastname} ${user.firstname}, (${user.idnumber})</p>`;
                                                    userDiv.addEventListener('click', () => selectUser(user.id, user.lastname, user.firstname, user.middlename));
                                                    userResults.appendChild(userDiv);
                                                }
                                            });
                                        })
                                        .catch(error => {
                                            console.error('Error fetching users:', error);
                                        });
                                    }
                                
                                    document.getElementById('userSearch').addEventListener('input', function() {
                                        const query = this.value.trim();
                                        if (query.length > 0) {
                                            fetchUsers(query); 
                                        } else {
                                            document.getElementById('userResults').innerHTML = ''; 
                                        }
                                    });
                                
                                    function selectUser(userId, lastname,firstname, middlename) {
                                        document.getElementById('userId').value = userId; 
                                        document.getElementById('userSearch').value = `${lastname} ${firstname} ${middlename}`; 
                                        document.getElementById('userResults').innerHTML = ''; 
                                    }
                                
                                    let allSemesterData = []; // Store all semester data for filtering
                            let filteredSemesterData = []; // Store filtered semester data based on search
                            let currentSemesterIndex = 0; // Track the current index of semesters displayed
                            
                            function fetchPaymentsBySemester() {
                                const token = localStorage.getItem('token');
                                if (!token) {
                                    window.location.href = 'adminlogin.html';
                                    return;
                                }
                            
                                fetch('https://finalccspayment.onrender.com/api/auth/payments/by-semesterorganization', {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to fetch payments');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    const content = document.querySelector('.contents');
                                    content.innerHTML = ''; // Clear previous content
                                    if (data.length === 0) {
                                        document.getElementById('errorMessages').innerText = 'No payments found for any semester.';
                                        return;
                                    }
                            
                                    allSemesterData = data; // Store all data for search functionality
                                    filteredSemesterData = data; // Initialize filtered data to all data
                                    currentSemesterIndex = 0; // Reset index on fetch
                            
                                    // Display only the first semester
                                    renderSemester(data[0], content);
                            
                                    // Scroll to the first semester on load (not strictly necessary as it will be displayed)
                                    const semesterId = `semester-${data[0].semester.replace(/\s+/g, '-')}`;
                                    const firstSemesterElement = document.getElementById(semesterId);
                                    if (firstSemesterElement) {
                                        firstSemesterElement.scrollIntoView({ behavior: 'smooth' });
                                    }
                                })
                                .catch(error => {
                                    console.error('Error fetching payments:', error);
                                    document.getElementById('errorMessages').innerText = 'An error occurred while fetching payments. Please try again later.';
                                });
                            }
                            
                            function renderSemester(semesterData, content) { 
    const semesterId = `semester-${semesterData.semester.replace(/\s+/g, '-')}`;
    const semesterSection = document.createElement('div');
    semesterSection.id = semesterId; // Set an ID for scrolling purposes

    // Display the semester title
    semesterSection.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: auto;">
    
        <h2 style="cursor: pointer; text-align: left; font-weight: bold;">
            ${semesterData.semester}
        </h2>

        <div style="display: flex; flex-direction: column; align-items: center;">
            <!-- Up Icon -->
            <button onclick="showPreviousSemester()" style="background: none; border: none; cursor: pointer;" 
                ${currentSemesterIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-chevron-up" style="font-size: 24px;"></i>
            </button>
            <!-- Down Icon -->
            <button onclick="showNextSemester()" style="background: none; border: none; cursor: pointer;" 
                ${currentSemesterIndex === filteredSemesterData.length - 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-down" style="font-size: 24px;"></i>
            </button>
        </div>

        <!-- Payment Button with Data Attribute -->
        <!-- Button to trigger the modal -->
<div style="display: flex; flex-direction: column; align-items: center;">
    <button class="btn btn-success" 
        data-bs-toggle="modal" 
        data-bs-target="#paymentModalAll"
        data-payments='${JSON.stringify(semesterData.payments)}' 
        data-semester-id='${semesterData.id}' 
        onclick="openPaymentModalAll(this)">
        <i class="fas fa-plus"></i>  <!-- Plus icon from Font Awesome -->
    </button>

    <div style="font-size: 10px; font-weight: bold;">Pay All now!</div>
</div>


      </div>
      <br>
    `;

    content.appendChild(semesterSection);
                            
                                if (semesterData.payments.length > 0) {
                                semesterData.payments.forEach(payment => {
                                    const paymentSection = document.createElement('div');

                                    let paymentTypeColor = 'black'; // Default color
        if (payment.payment_type === 'Mandatory') {
            paymentTypeColor = 'green';
        } else if (payment.payment_type === 'Not mandatory') {
            paymentTypeColor = '#3366cc';
        } else if (payment.payment_type === 'Other fees') {
            paymentTypeColor = 'gold';
        }
                                    paymentSection.innerHTML = `
                                        <div style="display: flex; align-items: center; justify-content: center;">
                                            <div class="d-flex align-items-center">
                                                <h4>${payment.name} ₱ ${payment.price} 
                        <span style="color: ${paymentTypeColor}; font-weight: bold;">(${payment.payment_type})</span>
                    </h4>
                                                
                                               
                            
                                                <div style="text-align: right;">
                                                    <button class="ellipsis-btn" onclick="toggleDetails('${payment.id}')">
                                                        &#x2026;
                                                    </button>
                                                </div>
                                                <div id="details-${payment.id}" class="details-container" style="display: none;">
                                                    <h4>${payment.created_by_name}</h4>
                                                    <img src="${payment.qrcode_picture}" alt="Qrcode" class="qrcode-img" />
                                                </div>
                                            </div>
                                        </div>
                                        <div id="transactions-${payment.id}" data-content="no-data" class="no-payment-message">
                                            <p>No transactions available.</p>
                                        </div>
                                        <br><br>
                                    `;
                                    content.appendChild(paymentSection);
                            
                                    // Fetch transactions for each payment 
                                    fetchTransactionsByPaymentId(payment.id);
                                    setInterval(() => {
                                        fetchTransactionsByPaymentId(payment.id);
                                    }, 10000);
                                });
                            }
                             else {
                                    const noPaymentMessage = document.createElement('p');
                            noPaymentMessage.innerText = 'No payment during this semester.';
                            
                            // Apply styles
                            noPaymentMessage.style.textAlign = 'center';  // Centers the text
                            noPaymentMessage.style.backgroundColor = '#F5FFFA';  // Set the background color
                            noPaymentMessage.style.color = 'darkgreen';  // Set the text color
                            noPaymentMessage.style.padding = '10px';  // Optional padding for better readability
                            noPaymentMessage.style.borderRadius = '5px';  // Optional rounded corners
                            noPaymentMessage.style.fontSize = '18px';  // Optional font size
                            noPaymentMessage.style.margin = '20px auto';  // Optional margin to center it and space it out
                            
                            content.appendChild(noPaymentMessage);
                                }
                            }
                            
                            function toggleDetails(paymentId) {
                                    const detailsElement = document.getElementById(`details-${paymentId}`);
                                    if (detailsElement.style.display === "none") {
                                        detailsElement.style.display = "block";
                                    } else {
                                        detailsElement.style.display = "none";
                                    }
                                }
                            function showNextSemester() {
                                if (currentSemesterIndex < filteredSemesterData.length - 1) {
                                    currentSemesterIndex++;
                                    updateSemesterDisplay();
                                }
                            }
                            
                            // Function to show the previous semester
                            function showPreviousSemester() {
                                if (currentSemesterIndex > 0) {
                                    currentSemesterIndex--;
                                    updateSemesterDisplay();
                                }
                            }
                            async function deletePayment(paymentId) {
                                const confirmation = await Swal.fire({
                                    title: 'Are you sure?',
                                    text: 'Do you want to delete this payment?',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: 'Yes, delete it!',
                                    cancelButtonText: 'No, cancel!'
                                });
                            
                                if (confirmation.isConfirmed) {
                                    try {
                                        const response = await fetch(`https://finalccspayment.onrender.com/api/auth/payments/delete/${paymentId}`, {
                                            method: 'DELETE',
                                            headers: {
                                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                                            }
                                        });
                            
                                        const result = await response.json();
                            
                                        if (response.ok) {
                                            Swal.fire('Deleted!', result.message, 'success').then(() => {
                                                window.location.reload(); // Reload to reflect the deletion
                                            });
                                        } else {
                                            Swal.fire('Error!', result.error || 'Failed to delete payment.', 'error');
                                        }
                                    } catch (error) {
                                        Swal.fire('Error!', 'An error occurred while deleting the payment.', 'error');
                                    }
                                }
                            }
                            
                            // Function to update the displayed semester
                            function updateSemesterDisplay() {
                                const content = document.querySelector('.contents');
                                content.innerHTML = ''; // Clear previous content
                                const semesterData = filteredSemesterData[currentSemesterIndex]; // Get the current semester data from filtered data
                                renderSemester(semesterData, content); // Render the current semester
                            }
                            
                            function searchSemester() {
                                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                            
                                // Filter the stored data based on the search term
                                filteredSemesterData = allSemesterData.filter(semester => 
                                    semester.semester.toLowerCase().includes(searchTerm)
                                );
                            
                                currentSemesterIndex = 0; // Reset index when searching
                                updateSemesterDisplay(); // Update the display with filtered semesters
                            
                                const content = document.querySelector('.contents');
                                if (filteredSemesterData.length > 0) {
                                    // Scroll to the first matching semester
                                    const firstMatch = filteredSemesterData[0];
                                    const semesterId = `semester-${firstMatch.semester.replace(/\s+/g, '-')}`;
                                    const semesterElement = document.getElementById(semesterId);
                                    if (semesterElement) {
                                        semesterElement.scrollIntoView({ behavior: 'smooth' });
                                    }
                                } else {
                                    content.innerHTML = '<p>No matching semesters found.</p>';
                                }
                            }
                            
                            
                            
                            
                            function fetchTransactionsByPaymentId(paymentId) { 
                                const token = localStorage.getItem('token');
                                if (!token) {
                                    window.location.href = 'adminlogin.html';
                                    return;
                                }
                            
                                fetch(`https://finalccspayment.onrender.com/api/auth/transactions/${paymentId}`, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to fetch transactions');
                                    }
                                    return response.json();
                                })
                                .then(transactions => {
                                    const transactionsContainer = document.getElementById(`transactions-${paymentId}`);
                                    
                                    if (!transactionsContainer) {
                                        console.error('Transactions container element not found.');
                                        return;
                                    }
                            
                                    // Clear any previous content
                                    transactionsContainer.innerHTML = '';
                            
                                    // Check if there are transactions
                                    if (transactions.length === 0) {
                                        transactionsContainer.innerHTML = '<p>No transactions available.</p>';
                                        return; // Exit if no transactions
                                    }
                            
                                    // Determine if there are any promissory notes
                                    const hasPromissoryNotes = transactions.some(tx => tx.promissory_note && tx.promissory_note.trim() !== '');
                            
                                    const table = document.createElement('table');
table.id = `transactionsTable-${paymentId}`;
table.className = 'custom-table';  // Applying the same class from semesterLogsTable

table.style.width = "100%"; // Ensuring full width like semesterLogsTable


table.innerHTML = `
    <thead>
        <tr>
            <th>Transaction ID</th>
            <th>Student Name</th>
            <th>Payment Method</th>
            <th>Total Amount</th>
            <th>Balance</th>
            <th>Date</th>
            <th>Status</th>
            <th>Received by</th>
            ${hasPromissoryNotes ? '<th>Promissory Notes</th>' : ''}
            <th>Action</th>
        </tr>
    </thead>


                                        <tbody>
                                ${transactions.map(tx => {
                                    let statusClass;
                                    switch (tx.payment_status) {
                                        case "Balance":
                                            statusClass = 'status-balance';
                                            break;
                                        case "Balance Gcash":
                                            statusClass = 'status-balance';
                                            break;
                                        case "Pending":
                                            statusClass = 'status-pending';
                                            break;
                                        case "Pending Balance":
                                            statusClass = 'status-pending';
                                            break;
                                        case "Paid":
                                            statusClass = 'status-paid';
                                            break;
                                        case "Processing":
                                            statusClass = 'status-processing';
                                            break;
                                        case "Decline":
                                            statusClass = 'status-decline';
                                            break;
                                        default:
                                            statusClass = ''; 
                                    }
                            
                                    const showDeclineButton = tx.payment_status === 'Pending' && tx.payment_method === 'Gcash';
                                    const showAddAmountButton = tx.payment_status === 'Processing' && tx.total_amount <= 0;
                            
                                    return `
                                        <tr>
                                            <td>${tx.transaction_id}</td>
                                            <td>${tx.user_firstname} ${tx.user_lastname}</td>
                                            <td>
                                                ${tx.payment_method === 'Gcash' ? `
                                                    ${tx.payment_method} <br>
<button 
    onclick="openGcashModal('${tx.transaction_id}')" 
    style="background-color: #007bff; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#0056b3'" 
    onmouseout="this.style.backgroundColor='#007bff'" 
    data-bs-toggle="modal" 
    data-bs-target="#qrgcash-${tx.transaction_id}">
    <i class="fas fa-qrcode" style="font-size: 18px;"></i>
</button>



                            <!-- Modal -->
<!-- GCash Proof of Payment Modal -->
<div class="modal fade" id="qrgcash-${tx.transaction_id}" tabindex="-1" aria-labelledby="qrgcashModalLabel-${tx.transaction_id}" aria-hidden="true">
    <div class="modal-dialog sm" style="max-width: 30%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrgcashModalLabel-${tx.transaction_id}">Gcash Proof of Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    <img src="${tx.proof_of_payment}" alt="Proof of Payment" class="img-fluid" style="max-width: 100%; max-height: 550px;" />
                </div>
            </div>
        </div>
    </div>
</div>
                                                ` : tx.payment_method}
                                            </td>
                                            <td>₱ ${tx.total_amount}</td>
                                            <td>₱ ${tx.balance}</td>
                                            <td>${new Date(tx.updated_at).toLocaleString('eng-PH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
})}</td>

                                            <td class="${statusClass}">${tx.payment_status}</td>
                                            <td>
                                                ${tx.received_firstname && tx.received_lastname ? `${tx.received_firstname} ${tx.received_lastname}` : 'There is no receiver yet'}
                                            </td>
                                            ${hasPromissoryNotes ? `
                                <td>
                                    ${tx.promissory_note && tx.promissory_note.trim() !== '' ? `
         <button 
    onclick="openPromissoryModal('${tx.transaction_id}')" 
    style="background-color: #007bff; color: white; border: none; border-radius: 5px; padding: 8px; cursor: pointer; font-size: 16px; width: 35px; height: 40px;">
    <i class="bi bi-eye" style="font-size: 18px;"></i>
</button>

                                        <div id="promissoryModal-${tx.transaction_id}" class="modal" style="display:none;">
                                            <div class="modal-content-promissory">
                                            <span style="position: absolute; right: 20px; cursor: pointer; margin-top: 20px;" class="close" onclick="closePromissoryModal('${tx.transaction_id}')">
                                <i class="fas fa-times-circle"></i>
                            </span>
                            
                                                <img src="${tx.promissory_note}" alt="Promissory Note" class="responsive-image" />
                                            </div>
                                        </div>

                                    ` : 'N/A'}
                                </td>
                            ` : ''}
                            
<td>
    <div style="display: flex; gap: 5px; align-items: center; flex-wrap: nowrap;">
        ${tx.payment_status === 'Pending' && tx.balance === 0 ? `
            <button 
    onclick="confirmAcceptPayment('${tx.transaction_id}', '${paymentId}')"
    style="background-color: #28a745; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#218838'" 
    onmouseout="this.style.backgroundColor='#28a745'">
    <i class="fa-solid fa-check" style="font-size: 20px;"></i>
</button>
            ${showDeclineButton ? `
        <button 
    onclick="confirmDeclinePayment('${tx.transaction_id}')"
    style="background-color: #dc3545; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#c82333'" 
    onmouseout="this.style.backgroundColor='#dc3545'">
    <i class="fa-solid fa-times" style="font-size: 20px;"></i>
</button>` : ''}
        ` : ''}

        ${tx.payment_status === 'Pending Balance' && tx.balance <= 0 ? `
            <button 
    onclick="confirmAcceptPaymentGcash('${tx.transaction_id}')"
    style="background-color: #28a745; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#218838'" 
    onmouseout="this.style.backgroundColor='#28a745'">
    <i class="fas fa-check" style="font-size: 20px;"></i>
</button>
          <button 
    onclick="confirmDeclinePaymentGcash('${tx.transaction_id}')"
    style="background-color: #dc3545; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#c82333'" 
    onmouseout="this.style.backgroundColor='#dc3545'">
    <i class="fas fa-times" style="font-size: 20px;"></i>
</button>
        ` : ''}

        ${tx.payment_status === 'Balance' || (tx.payment_status === 'Processing' && tx.total_amount > 0) ? `
            ${(tx.payment_method === 'Cash' || tx.payment_method === null || tx.payment_method === 'None') && tx.promissory_note ? `
                <button 
                    style="background-color: #ff69b4; color: white; border: none; border-radius: 5px; padding: 8px; cursor: pointer; font-size: 16px; width: 40px; height: 40px;" 
                    onclick="openTransactionModalPending('${tx.transaction_id}', ${tx.balance})">
                    <i class="bi bi-credit-card"></i>
                </button>
            ` : ''}
        ` : ''}

        ${tx.payment_status === 'Balance Gcash' || (tx.payment_status === 'Processing' && tx.total_amount > 0) ? `
            ${tx.payment_method === 'Gcash' && tx.promissory_note ? `
                <button 
    style="background-color: #ff69b4; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onclick="openTransactionModal('${tx.transaction_id}', ${tx.balance})"
    onmouseover="this.style.backgroundColor='#e35c8a'" 
    onmouseout="this.style.backgroundColor='#ff69b4'">
    <i class="bi bi-credit-card" style="font-size: 20px;"></i>
</button>
            ` : ''}
        ` : ''}

        ${showAddAmountButton ? `
           <button 
    onclick="openTransactionModaladdtotalamount('${tx.transaction_id}', ${tx.balance})"
    style="background-color: #198754; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onmouseover="this.style.backgroundColor='#157a4b'" 
    onmouseout="this.style.backgroundColor='#198754'">
    <i class="fas fa-peso-sign" style="font-size: 20px;"></i>
</button>
        ` : ''}

        ${tx.payment_status === 'Balance' || tx.payment_status === 'Balance Gcash' || tx.payment_status === 'Paid' || tx.payment_status === 'Processing' || tx.payment_status === 'Pending Balance' ? `
          <button 
    style="background-color: #007bff; 
           color: white; 
           border: none; 
           border-radius: 5px; 
           padding: 8px; 
           width: 35px; 
           height: 35px; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           cursor: pointer; 
           font-size: 16px; 
           transition: background-color 0.3s;" 
    onclick="openTransactionModalHistory('${tx.transaction_id}', '${tx.user_firstname}', '${tx.user_lastname}')"
    onmouseover="this.style.backgroundColor='#0056b3'" 
    onmouseout="this.style.backgroundColor='#007bff'">
    <i class="fas fa-history" style="font-size: 20px;"></i>
</button>

        ` : ''}
    </div>

    ${tx.payment_status === 'Decline' || (!tx.payment_status || !tx.payment_status.match(/(Pending|Balance|Processing|Paid)/)) ? `
        <p><i>This transaction has been declined</i></p>
    ` : ''}
</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                                    `;
                                    transactionsContainer.appendChild(table);
                            
                      // Initialize DataTables on the created table and sort by the Date column (index 5) in descending order
                      $(document).ready(function () {
    const dataTables = {};

    // Initialize all transaction tables
    $('table[id^="transactionsTable-"]').each(function() {
        const $table = $(this);
        const tableId = $table.attr('id');
        const paymentId = tableId.split('-')[1];

        // Check if already initialized
        if ($.fn.DataTable.isDataTable(this)) {
            dataTables[paymentId] = $table.DataTable();
            return; // Skip already initialized tables
        }

        // Initialize with retrieve option
        const table = $table.DataTable({
            dom: '<"top"f>rt<"bottom"lip>',
            order: [[5, 'desc']],
            lengthMenu: [10, 25, 50, 100],
            buttons: [
                { extend: 'copy', className: 'export-copy' },
                { extend: 'csv', className: 'export-csv' },
                { extend: 'excel', className: 'export-excel' },
                { extend: 'pdf', className: 'export-pdf' },
                { extend: 'print', className: 'export-print' }
            ],
            retrieve: true // Critical fix for reinitialization
        });

        dataTables[paymentId] = table;

        // Rest of your code (dropdown creation and event handlers)
        const dropdownHtml = `
       
            <div class="export-container">
                <div class="export-dropdown">
                    <button class="export-btn">
                        Export <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="export-content">
                        <a href="#" data-export-type="copy" data-payment-id="${paymentId}">Copy</a>
                        <a href="#" data-export-type="print" data-payment-id="${paymentId}">Print</a>
                        <a href="#" data-export-type="pdf" data-payment-id="${paymentId}">PDF</a>
                        <a href="#" data-export-type="csv" data-payment-id="${paymentId}">CSV</a>
                        <a href="#" data-export-type="excel" data-payment-id="${paymentId}">Excel</a>
                    </div>
                </div>
            </div>
           
        `;

        $table.before(dropdownHtml);

        // Add dropdown toggle functionality
        const $container = $(this).prev('.export-container');
        $container.find('.export-btn').on('click', function(e) {
            e.stopPropagation();
            $(this).siblings('.export-content').toggle();
        });

        // Handle export clicks
        $container.find('.export-content a').on('click', function(e) {
            e.preventDefault();
            const type = $(this).data('exportType');
            const paymentId = $(this).data('paymentId');
            dataTables[paymentId].buttons(`.export-${type}`).trigger();
        });

        // Close dropdown when clicking outside
        $(document).on('click', function() {
            $container.find('.export-content').hide();
        });
    });
});


                            
                            
                            
                                })
                                .catch(error => console.error('Error fetching transactions:', error));
                            }
                            
                            function openPromissoryModal(transactionId) {
                                const modal = document.getElementById(`promissoryModal-${transactionId}`);
                                if (modal) {
                                    modal.style.display = 'block';
                                }
                            }
                            
                            function closePromissoryModal(transactionId) {
                                const modal = document.getElementById(`promissoryModal-${transactionId}`);
                                if (modal) {
                                    modal.style.display = 'none';
                                }
                            }
                          

                            
                            
                            
                            
                            function openTransactionModaladdtotalamount(transactionId, paymentId) {
    document.getElementById('transaction_id').value = transactionId;
    document.getElementById('addAmountModal').style.display = 'block';

    // Ensure the hidden input for paymentId exists before assigning value
    const paymentInput = document.getElementById('payment_id');
    if (paymentInput) {
        paymentInput.value = paymentId;
    } else {
        console.error("payment_id input not found!");
    }
}

// Close modal function
function closeTransactionModal() {
    document.getElementById('addAmountModal').style.display = 'none';
}

// Ensure `payment_id` exists inside your form:
document.getElementById('addAmountModal').innerHTML += `
    <input type="hidden" id="payment_id">
`;

// Form submission for adding amount
document.getElementById('addAmountForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const transactionId = document.getElementById('transaction_id').value;
    const paymentId = document.getElementById('payment_id').value; // Retrieve stored paymentId
    const totalAmount = parseFloat(document.getElementById('total_amount').value);
    const token = localStorage.getItem('token');

    if (!transactionId || !paymentId) {
        Swal.fire('Error!', 'Missing transaction or payment ID.', 'error');
        return;
    }

    if (totalAmount <= 0) {
        Swal.fire('Error!', 'Total amount must be greater than 0.', 'error');
        return;
    }

    Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to add the transaction amount.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'No, cancel!',
        confirmButtonColor: '#28a745',
        cancelButtonColor: 'red',
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while we add amount to the transaction.',
                icon: 'info',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`https://finalccspayment.onrender.com/api/auth/transactions/add-amount/${transactionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    total_amount: totalAmount,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: 'Transaction amount has been added successfully.',
                        icon: 'success',
                        confirmButtonText: 'OK',
                    }).then(() => {
                        closeTransactionModal(); // Close modal
                        document.getElementById('addAmountForm').reset(); // Reset form
                        fetchTransactionsByPaymentId(paymentId); // Refresh transactions using paymentId
                    });
                } else {
                    Swal.fire('Error!', data.message || 'An error occurred.', 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error!', 'An error occurred while processing the request.', 'error');
                console.error('Error:', error);
            });
        }
    });
});


// Attach the function to the form submit event




                            
                            
                            
                            function confirmAcceptPaymentGcash(transactionId) {
                              Swal.fire({
                                title: 'Are you sure?',
                                text: "You are about to accept the payment.",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#28a745',
                                cancelButtonColor: 'red',
                                confirmButtonText: 'Yes, accept it!'
                              }).then((result) => {
                                if (result.isConfirmed) {
                                  Swal.fire({
                                    title: 'Processing...',
                                    text: 'Please wait while we accept the payment.',
                                    allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                  });
                                  acceptPaymentGcash(transactionId);
                                }
                              });
                            }
                            
                            function confirmDeclinePaymentGcash(transactionId) {
                              Swal.fire({
                                title: 'Are you sure?',
                                text: "You are about to decline the payment.",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#28a745',
                                cancelButtonColor: 'red',
                                confirmButtonText: 'Yes, decline it!'
                              }).then((result) => {
                                if (result.isConfirmed) {
                                  Swal.fire({
                                    title: 'Processing...',
                                    text: 'Please wait while we decline the payment.',
                                    allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                  });
                                  declinePaymentGcash(transactionId);
                                }
                              });
                            }
                            
                            
                            function acceptPaymentGcash(transactionId) {
                              // Get token from localStorage (or replace this with the appropriate method)
                              const token = localStorage.getItem('token');
                            
                              fetch(`https://finalccspayment.onrender.com/api/auth/transactions/accept-paymentGcash/${transactionId}`, {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                  'Authorization': `Bearer ${token}` // Add the token to the Authorization header
                                },
                              })
                                .then(response => response.json())
                                .then(data => {
                                  if (data.success) {
                                    Swal.fire({
                                      title: 'Accepted!',
                                      text: 'The payment status has been updated to Processing.',
                                      icon: 'success',
                                      confirmButtonText: 'OK'
                                    }).then(() => {
                                        fetchTransactionsByPaymentId(paymentId); // Reload the page
                                    });
                                  } else {
                                    Swal.fire('Error!', data.error, 'error');
                                  }
                                })
                                .catch(error => Swal.fire('Error!', 'An error occurred.', 'error'));
                            }
                            
                            function declinePaymentGcash(transactionId) {
                              // Get token from localStorage
                              const token = localStorage.getItem('token');
                            
                              // Show loading message
                              Swal.fire({
                                title: 'Processing...',
                                text: 'Please wait while we process your request.',
                                allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                              });
                            
                              fetch(`https://finalccspayment.onrender.com/api/auth/transactions/decline-paymentGcash/${transactionId}`, {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                  'Authorization': `Bearer ${token}`, // Add the token to the Authorization header
                                },
                              })
                                .then(response => response.json())
                                .then(data => {
                                  if (data.success) {
                                    Swal.fire({
                                      title: 'Declined!',
                                      text: 'The payment has been declined.',
                                      icon: 'success',
                                      confirmButtonText: 'OK',
                                    }).then(() => {
                                      // Open the report modal
                                      openReportModal(transactionId);
                                    });
                                  } else {
                                    Swal.fire('Error!', data.error, 'error');
                                  }
                                })
                                .catch(error => {
                                  console.error('Error:', error);
                                  Swal.fire('Error!', 'An error occurred.', 'error');
                                });
                            }
                            
                            
                            
                            
                            function confirmAcceptPayment(transactionId, paymentId) {
                              Swal.fire({
                                title: 'Are you sure?',
                                text: "You are about to accept the payment.",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#28a745',
                                cancelButtonColor: 'red',
                                confirmButtonText: 'Yes, accept it!'
                              }).then((result) => {
                                if (result.isConfirmed) {
                                  acceptPayment(transactionId, paymentId);
                                }
                              });
                            }
                            
                            
                            function confirmDeclinePayment(transactionId) {
                              Swal.fire({
                                title: 'Are you sure?',
                                text: "You are about to decline the payment.",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#28a745',
                                cancelButtonColor: 'red',
                                confirmButtonText: 'Yes, decline it!'
                              }).then((result) => {
                                if (result.isConfirmed) {
                                  Swal.fire({
                                    title: 'Processing...',
                                    text: 'Please wait while we process your request.',
                                    allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                                  });
                                  declinePayment(transactionId);
                                }
                              });
                            }
                            
                            function acceptPayment(transactionId, paymentId) {
                              const token = localStorage.getItem('token');
                            
                              // Show loading message
                              Swal.fire({
                                title: 'Processing...',
                                text: 'Please wait while we process your request.',
                                icon: 'info',
                                showConfirmButton: false,
                                allowOutsideClick: false,
                              });
                            
                              fetch(`https://finalccspayment.onrender.com/api/auth/transactions/accept-payment/${transactionId}`, {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                  'Authorization': `Bearer ${token}`
                                },
                              })
                                .then(response => response.json())
                                .then(data => {
                                  if (data.success) {
                                    Swal.fire({
                                      title: 'Accepted!',
                                      text: 'The payment status has been updated to Processing.',
                                      icon: 'success',
                                      confirmButtonText: 'OK'
                                    }).then(() => {
                                      // Refresh the relevant payment's transactions
                                      fetchTransactionsByPaymentId(paymentId);
                                    });
                                  } else {
                                    Swal.fire('Error!', data.error, 'error');
                                  }
                                })
                                .catch(error => {
                                  Swal.fire('Error!', 'An error occurred.', 'error');
                                });
                            }
                            
                            
                            function declinePayment(transactionId) {
                              const token = localStorage.getItem('token');
                            
                              // Show loading message
                              Swal.fire({
                                title: 'Processing...',
                                text: 'Please wait while we process your request.',
                                allowOutsideClick: false,
                                        didOpen: () => {
                                            Swal.showLoading();
                                        }
                              });
                            
                              fetch(`https://finalccspayment.onrender.com/api/auth/transactions/decline-payment/${transactionId}`, {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/json',
                                  'Authorization': `Bearer ${token}`
                                },
                              })
                                .then(response => response.json())
                                .then(data => {
                                  if (data.success) {
                                    Swal.fire({
                                      title: 'Declined!',
                                      text: 'The payment has been declined.',
                                      icon: 'success',
                                      confirmButtonText: 'OK'
                                    }).then(() => {
                                      // Open the report modal after successfully declining the payment
                                      openReportModal(transactionId);
                                    });
                                  } else {
                                    Swal.fire('Error!', data.error, 'error');
                                  }
                                })
                                .catch(error => {
                                  Swal.fire('Error!', 'An error occurred.', 'error');
                                });
                            }
                            
                            function openReportModal(transactionId) {
                              document.getElementById('reportTransactionId').value = transactionId; // Pass the transaction ID to the modal
                              document.getElementById('transactionReportModal').style.display = 'block'; // Show the modal
                            }
                            
                            function closeReportModal() {
                              document.getElementById('transactionReportModal').style.display = 'none'; // Hide the modal
                              document.getElementById('transactionReportForm').reset(); // Reset the form inside the modal
                            }
                            
                            
                            document.getElementById('transactionReportForm').addEventListener('submit', async (e) => { 
    e.preventDefault();

    const transaction_id = document.getElementById('reportTransactionId').value;
    const reason = document.querySelector('input[name="reason"]:checked').value;
    const description = document.getElementById('description').value;

    // Show confirmation prompt
    Swal.fire({
        title: "Confirm Submission",
        text: "Are you sure you want to submit this transaction report?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, Submit",
        cancelButtonText: "No, Cancel"
    }).then(async (result) => {
        if (result.isConfirmed) {
            // Show loading message
            Swal.fire({
                title: "Submitting Report...",
                text: "Please wait...",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('https://finalccspayment.onrender.com/api/auth/transactions/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    },
                    body: JSON.stringify({ transaction_id, reason, description }),
                });

                const result = await response.json();
                if (result.success) {
                    // Show success message
                    setTimeout(() => {
                        Swal.fire({
                            title: "Report Submitted!",
                            text: result.message,
                            icon: "success",
                        }).then(() => {
                            closeReportModal();
                            fetchTransactionsByPaymentId(paymentId);
                        });
                    }, 2000); // Wait for 2 seconds before success message
                } else {
                    Swal.fire("Error!", result.message, "error");
                }
            } catch (error) {
                console.error("Error submitting report:", error);
                Swal.fire("Error!", "An error occurred while submitting the report.", "error");
            }
        }
    });
});


                            
                            
                            
                            
                            function openPaymentModal(paymentId) {
                                document.getElementById('paymentId').value = paymentId;
                                fetchUsers('');  
                                showModal();
                            }
                            
                            document.getElementById('paymentForm').addEventListener('submit', function (event) {
                                event.preventDefault();
                            
                                const paymentId = document.getElementById('paymentId').value;
                                const userId = document.getElementById('userId').value;
                                const totalAmount = document.getElementById('totalAmount').value;
                            
                                const token = localStorage.getItem('token');
                                if (!token) {
                                    window.location.href = 'adminlogin.html';
                                    return;
                                }
                            
                                Swal.fire({
                                    title: 'Confirm Payment',
                                    text: "Are you sure you want to add this payment?",
                                    icon: 'question',
                                    showCancelButton: true,
                                    confirmButtonColor: '#28a745',
                                    cancelButtonColor: 'red',
                                    confirmButtonText: 'Yes, add it!',
                                    cancelButtonText: 'No, cancel'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // Show loading message
                                        Swal.fire({
                                            title: 'Processing...',
                                            text: 'Please wait while the payment is being processed.',
                                            icon: 'info',
                                            showConfirmButton: false,
                                            allowOutsideClick: false,
                                            didOpen: () => {
                                                Swal.showLoading();
                                            }
                                        });
                            
                                        fetch(`https://finalccspayment.onrender.com/api/auth/payments/insert/${paymentId}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({ userId, totalAmount })
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                Swal.close(); // Close the loading message
                                                if (data.message.includes('already has a transaction')) {
                                                    Swal.fire({
                                                        title: 'Transaction Exists',
                                                        text: data.message,
                                                        icon: 'error',
                                                        confirmButtonText: 'OK'
                                                    });
                                                } else if (data.message.includes('Total amount exceeds the price')) {
                                                    Swal.fire({
                                                        title: 'Amount Error',
                                                        text: data.message,
                                                        icon: 'warning',
                                                        confirmButtonText: 'OK'
                                                    });
                                                } else {
                                                    Swal.fire({
                                                        title: 'Success!',
                                                        text: data.message,
                                                        icon: 'success',
                                                        confirmButtonText: 'OK'
                                                    }).then(() => {
                                                        // Clear the modal form fields
                                                        document.getElementById('paymentForm').reset();
                                                        
                                                        closeModal(); // Hide the modal
                                                        // Refresh the relevant payment's transactions
                                                        fetchTransactionsByPaymentId(paymentId);
                                                    });
                                                }
                                            })
                                            .catch(error => {
                                                Swal.close(); // Close the loading message
                                                console.error('Error adding payment:', error);
                                                Swal.fire({
                                                    title: 'Error',
                                                    text: 'An error occurred while adding the payment. Please try again later.',
                                                    icon: 'error',
                                                    confirmButtonText: 'OK'
                                                });
                                            });
                                    }
                                });
                            });
                            
                            
                                
                                    fetchPaymentsBySemester();
                                    </script>
                                </div>  
                            </div>
                        </div>   
                    </div>  
                </main>      
            </div>
        </div>
        <script src="/static/js/scripts.js"></script>
        <link rel="stylesheet" href="/static/css/styles.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    </body>
</html>
