<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="x-icon" href="img/logo.png"> <!-- Ensure img/logo.png exists -->
    <title>ORGANIZATION ORDERS</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #F5FFFA;
        }

        .top {
            background-color: #F5FFFA;
            position: fixed;
            width: 100%;
            z-index: 0;
            display: flex;
            justify-content: end;
            align-items: center;
            padding-right: 20px;
            z-index: 2;
        }

        .sidebar {
            width: 11vw;
            background-color: #F5FFFA; 
            color: rgb(0, 0, 0);
            display: flex;
            flex-direction: column;            
            z-index: 3;            
        }
        .main-content {
        width: 85vw;
        background-color: rgb(221, 231, 221);
        margin-left: 30px;
        height: 600px;
        position: relative; 
        border-radius: 10px;
    }

    .full-container {
        display: flex;
        flex-direction: column;
        margin-top: 80px;
        border-radius: 10px;
    }

        .sidebar .logo {
            padding: 20px;
            text-align: center;
        }

        .sidebar .logo img {
            max-width: 110px;
            height: auto;
        }

        .sidebar .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgb(0, 0, 0);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sidebar .nav-item .icon {
            margin-right: 15px;
        }

        .sidebar .nav-item .text {
            font-size: 16px;
        }

        .sidebar .nav-item.active {
            font-weight: bold;
            color: #f1f1f1; /* Light color for contrast */
        }

        .sidebar .nav-item.active .icon {
            color: #f1f1f1; /* Light color for contrast */
        }

        .sidebar .bottom-links {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #fff;
        }

        .sidebar .bottom-links .nav-item {
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            
        }

        .sidebar .bottom-links .nav-item:hover {
            background-color: #085d15; /* Slightly darker green */
        }

       
        .spacer {
            flex: 1;
        }

        
        h1 {
            font-size: 40px;
            margin-top: 40px;
            margin-left: 40px;
            font-weight: bold;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        h3 {
            font-size: 20px;
            text-align: right;
            font-weight: bold;
           
        }

        .add-account-btn {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .set-semester-btn {
            position: absolute;
            top: 20px; 
            right: 20px; 
        }
        .content {
            margin-left: 260px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
       
        table {
    width: 97%;
    margin: 20px auto; 
    border-collapse: separate; 
    border-spacing: 0 10px; 
    max-width: 100%; 
}

th, td {
     
    padding: 8px;
    text-align: left;
    background-color: #ffffff;
}


th:first-child {
    border-top-left-radius: 8px; 
    border-bottom-left-radius: 8px; 
}

th:last-child {
    border-top-right-radius: 8px; 
    border-bottom-right-radius: 8px; 
}


td:first-child {
    border-top-left-radius: 8px; 
    border-bottom-left-radius: 8px; 
}

td:last-child {
    border-top-right-radius: 8px; 
    border-bottom-right-radius: 8px; 
}


th {
    background-color: #034b03;
    color: white;
    font-weight: bold;  
    font-size: 14px;
}


tr:hover td {
    background-color: #ddfadc;
    transform: translateX(5px) scale(1.05); 
    transition: transform 0.2s ease-in-out; 
    color: black;}

.icon-button {
    border: none;
    background-color: transparent;
    border-radius: 50%;
    padding: 10px;
    cursor: pointer;
    color: #034b03;
    transition: background-color 0.3s, transform 0.2s;
}

.icon-button:hover {
    background-color: rgba(3, 75, 3, 0.1); 
    transform: scale(1.1); 
}


.dropdown-item {
    width: 100%;
    border: none;
    background-color: transparent;
    padding: 10px;
    text-align: left;
    cursor: pointer;
    color: #034b03;
    transition: background-color 0.3s;
}

.dropdown-item:hover {
    background-color: rgba(3, 75, 3, 0.1); 
}


.icon-button:hover + .dropdowns {
    display: block; 
}
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 70%;
}
#userResults {
    max-height: 100px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    margin-top: 8px;
    padding: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}


.user-item {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.user-item:hover {
    background-color: #f0f0f0;
}#productResults img {
        max-width: 100px;
        height: auto;
        display: block;
    }
/* Style for product item */
.product-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.3s, border-color 0.3s;
}

/* Hover effect for product item */
.product-item:hover {
    background-color: #f9f9f9;
}

/* Highlight style for selected product */
.selected {
    background-color: #d1ecf1; /* Light blue color for highlighting */
    border-color: #17a2b8; /* Border color to match the highlight */
}
.modal-content {
  background-color: #fefefe;
  margin: 1% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 70%;
}
.close {
    color: #cf0303;
    position: absolute;
    right: 20px;
    top: 0px;
    font-size: 28px;
    font-weight: bold;
}
.closes {
    color: #aaa;
    right: 20px;
    top: 30px;
    font-size: 28px;
    font-weight: bold;
}.closes:hover,
.closes:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

    </style>    
</head>
<body>


<div class="sidebar">
   
    <div class="logo">
        <img src="img/logo.png" alt="Logo">
    </div>
   
    <a href="organization-dashboard.html" class="nav-item" id="dashboard-link">
        <div class="icon">
            <i class="bi bi-speedometer2"></i> <!-- Updated icon for dashboard -->
        </div>
        <div class="text" style="font-weight: normal;">Dashboard</div>
    </a>
    <a href="organization-orders.html" class="nav-item" id="orders-link" style="background-color: #034b03; color: white;  border-radius: 15px;">
        <div class="icon">
            <i class="bi bi-cart"></i> <!-- Updated icon for orders -->
        </div>
        <div class="text" style="font-weight: bold;">Orders</div>
    </a>
    <a href="organization-payment.html" class="nav-item" id="payment-link">
        <div class="icon">
            <i class="bi bi-credit-card"></i> <!-- Updated icon for payment -->
        </div>
        <div class="text">Payment</div>
    </a>
    <a href="organization-products.html" class="nav-item" id="products-link">
        <div class="icon">
            <i class="bi bi-box-seam"></i> <!-- Updated icon for products -->
        </div>
        <div class="text">Products</div>
    </a>
    <a href="organization-masterlist.html" class="nav-item" id="masterlist-link">
        <div class="icon">
            <i class="bi bi-list-task"></i> <!-- Updated icon for masterlist -->
        </div>
        <div class="text">Masterlist</div>
    </a>
    

   
</div>




<div class="top d-flex justify-content-end align-items-center p-2">
    <div id="organizationInfo" class="d-flex flex-grow-1">
        
    </div>
    
    <i style="margin-right: 20px;">
        <li id="profile-item" class="dropdown-item">
            <a href="#">Loading...</a>
        </li>
    </i>
    <div class="dropdownsss" style="margin-right: 30px;">
        <a href="#" class="d-flex align-items-center text-decoration-none"  id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            
            <i class="fas fa-user-circle fa-2x" style="color: #25330f;"></i>
           
            <i class="fas fa-caret-down ms-2" style="color: #25330f;"></i>

            

        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            

            <li><a class="dropdown-item" href="#" id="logout">Sign Out</a></li>
        </ul>
    </div>
</div>
<script>
    function fetchLoggedInUserDetails() {
    const token = localStorage.getItem('token'); // Retrieve the token from localStorage

    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch('https://finalccspayment.onrender.com/api/auth/organization-user/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(user => {
        if (!user) {
            throw new Error('User not found');
        }
        
        
        const fullName = `${user.firstname} ${user.lastname}`; 

        document.getElementById('profile-item').innerHTML = `
           <a style="color: #25330f; text-decoration: none; " href="organization-users-info.html">
   
    <h3 style="font-style: normal; margin-top: 10px;">${user.firstname} ${user.lastname}</h3>
</a>

        `;
    })
    .catch(error => {
        console.error('Error fetching organization user details:', error);
        document.getElementById('profile-item').innerHTML = '<a href="#">Error loading profile</a>';
    });
}

// Call the function when the DOM is loaded
document.addEventListener('DOMContentLoaded', fetchLoggedInUserDetails);

</script>

<script>

    document.addEventListener('DOMContentLoaded', fetchOrganizationUserDetails);
    document.getElementById('logout').addEventListener('click', function(event) {
               event.preventDefault(); 
       
               
               localStorage.removeItem('token');
       
               
               window.location.href = 'adminlogin.html';
           });
   
   document.addEventListener('DOMContentLoaded', function() {
       const links = document.querySelectorAll('.sidebar .nav-item');

       links.forEach(link => {
           link.addEventListener('click', function() {
              
               links.forEach(item => item.classList.remove('active'));
               
               this.classList.add('active');
           });
       });
   });
</script>
<div class="full-container">

    
    <div id="payment-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
        <h2>Enter Payment</h2>
        <p id="total-amount-info" style="margin-bottom: 10px;">Total Amount: </p>
        <label for="total-pay-input">Total Pay:</label>
        <input type="number" id="total-pay-input" placeholder="Enter total pay" min="0" step="0.01" style="width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box;" />
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="confirm-payment-btn" style="padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirm Payment</button>
            <button onclick="closePaymentModal()" style="padding: 10px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>
    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
    
    <script>
        let currentOrderTransactionId = null;
        let currentTotalAmount = null;
    
        function showPaymentModal(orderTransactionId, totalAmount) {
            currentOrderTransactionId = orderTransactionId;
            currentTotalAmount = totalAmount;
    
            
            document.getElementById('total-amount-info').innerText = `Total Amount: ${totalAmount.toFixed(2)}`;
    
            // Show modal and overlay
            document.getElementById('payment-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
    
            // Clear and focus the input field
            const inputField = document.getElementById('total-pay-input');
            inputField.value = '';
            inputField.focus();
        }
    
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
    
            currentOrderTransactionId = null;
            currentTotalAmount = null;
        }
    
        document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
            const totalPay = parseFloat(document.getElementById('total-pay-input').value);
    
            if (isNaN(totalPay) || totalPay < 0) {
                alert('Please enter a valid payment amount.');
                return;
            }
    
            if (totalPay > currentTotalAmount) {
                alert('Payment cannot exceed the total amount.');
                return;
            }
    
            try {
                const apiUrl = `https://finalccspayment.onrender.com/api/auth/product-transactions/${currentOrderTransactionId}/pay`;
                const token = localStorage.getItem('token');
    
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ totalPay }),
                });
    
                const data = await response.json();
    
                if (!response.ok) {
                    alert(data.message || 'Failed to update payment.');
                    return;
                }
    
                alert(data.message);
                closePaymentModal();
                fetchProductTransactions(); 
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('An error occurred while processing the payment.');
            }
        });
    </script>
    

    </script>

<div id="paybalancemodal" style="display: none;">
    <div>
        <h2>Pay Balance</h2>
        <p id="current-total-info"></p>
        <p id="balance-info"></p>
        <input type="number" id="balance-pay-input" placeholder="Enter balance payment" />
        <button id="confirm-balance-payment-btn">Confirm Balance Payment</button>
        <button onclick="closeBalancePaymentModal()">Close</button>
    </div>
</div>

<script>
    let currentBalanceTransactionId = null;
    let currentTotalPay = null;
    let currentTotalAmounts = null;

    function showBalancePaymentModal(orderTransactionId, totalAmount, totalPay) {
        currentBalanceTransactionId = orderTransactionId;
        currentTotalAmounts = parseFloat(totalAmount).toFixed(2); 
        currentTotalPay = parseFloat(totalPay).toFixed(2); 

        const remainingBalance = (totalAmount - totalPay).toFixed(2);
        document.getElementById('current-total-info').innerText = `Current Total Paid: ${currentTotalPay}`;
        document.getElementById('balance-info').innerText = `Remaining Balance: ${remainingBalance}`;

        const modal = document.getElementById('paybalancemodal');
        modal.style.display = 'block';
    }

    function closeBalancePaymentModal() {
        const modal = document.getElementById('paybalancemodal');
        modal.style.display = 'none';
        currentBalanceTransactionId = null;
        currentTotalAmounts = null;
        currentTotalPay = null;
        document.getElementById('balance-pay-input').value = ''; // Reset input field
    }

    // Handle balance payment confirmation
    document.getElementById('confirm-balance-payment-btn').addEventListener('click', () => {
        const additionalPay = parseFloat(document.getElementById('balance-pay-input').value).toFixed(2);

        if (!additionalPay || additionalPay <= 0) {
            alert('Please enter a valid payment amount.');
            return;
        }

        const remainingBalance = (currentTotalAmounts - currentTotalPay).toFixed(2);

        // Allow exact matches but reject overpayments
        if (parseFloat(additionalPay) > parseFloat(remainingBalance)) {
            alert('Payment cannot exceed the remaining balance.');
            return;
        }

        // Ensure the payment matches exactly when reaching the balance
        if (
            parseFloat(additionalPay) + parseFloat(currentTotalPay) > parseFloat(currentTotalAmounts)
        ) {
            alert('Total payment exceeds the total amount due.');
            return;
        }

        const apiUrl = `https://finalccspayment.onrender.com/api/auth/product-transactions/${currentBalanceTransactionId}/paybalance`;
        const token = localStorage.getItem('token');

        fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ totalPay: additionalPay, paymentMethod: 'Gcash' })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message);
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                closeBalancePaymentModal();
                fetchProductTransactions(); // Refresh transactions
            })
            .catch(error => {
                console.error('Error processing balance payment:', error);
                alert('Failed to process balance payment. Please try again.');
            });
    });
</script>

<!-- Modal for Product Transaction Logs -->
<div id="producttransactionlogsmodal" class="modal" 
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000;">
    
     <div class="modal-content" 
         style="background-color: #ffffff; width: 80%; max-width: 1000px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); overflow: hidden;justify-content: center; align-items: center; left: 0;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; text-align: center;">
            <h4 style="margin: 0; font-size: 24px; color: #333;">Product Transaction Logs</h4>
        </div>
        <div style="padding: 20px; overflow-y: auto; max-height: 400px; width: 1000px;">
            <table id="transaction-logs-table" style="width: 100%; border-collapse: collapse; font-size: 16px; color: #333;">
                <thead>
                    <tr style="background-color: #f8f9fa; text-align: left;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Action Message</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Status</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Payment Method</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Total Amount</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Total Pay</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">Accepted By</th>
                    </tr>
                </thead>
                <tbody id="transaction-logs-body">
                    <!-- Logs will be inserted here dynamically -->
                </tbody>
            </table>
        </div>
        <div style="padding: 20px; text-align: right; border-top: 1px solid #e0e0e0;">
            <span style="position: absolute; right: 20px; cursor: pointer; margin-top: 20px;" class="close" onclick="closeModal() ">
                <i class="fas fa-times-circle"></i>
            </span> 
        </div>
    </div>
</div>
<script>function showTransactionLogsModal(orderTransactionId) {
    const apiUrl = `https://finalccspayment.onrender.com/api/auth/product-transaction-logs/${orderTransactionId}`;
    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        const logsBody = document.getElementById('transaction-logs-body');
        logsBody.innerHTML = ''; // Clear the existing logs before adding new ones

        data.forEach(log => {
            const row = document.createElement('tr');
            row.innerHTML = `
                
                <td>${log.action_message}</td>
                <td>${log.status}</td>
                <td>${log.payment_method}</td>
                <td>${log.total_amount}</td>
                <td>${log.total_pay}</td>
                <td>
    ${log.accepted_by === '0' || log.accepted_by === 0 ? 'There is no receiver yet' : `${log.accepted_by_firstname} ${log.accepted_by_middlename} ${log.accepted_by_lastname}`}
</td>

                
            `;
            logsBody.appendChild(row);
        });

        // Display the modal
        const modal = document.getElementById('producttransactionlogsmodal');
        modal.style.display = 'block';
    })
    .catch(error => {
        console.error('Error fetching product transaction logs:', error);
    });
}

function closeModal() {
    const modal = document.getElementById('producttransactionlogsmodal');
    modal.style.display = 'none';
}
</script>
<div id="addOrderModal" class="modal">
    <div class="modal-content">
        <h4>Select User</h4>
        <input type="text" id="userSearch" name="userSearch" placeholder="Search user by name or ID number" required>
        <div id="userResults"></div>
        <input type="hidden" id="userId" name="userId">

        <h4>Select Products</h4>
        <div id="productResults"></div>
        <div id="selectedProductsContainer">
            <h5>Selected Products</h5>
            <table id="selectedProductsTable" border="1">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Small</th>
                        <th>Medium</th>
                        <th>Large</th>
                        <th>X-Large</th>
                        <th>Price</th>
                        <th>Total Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Selected products will be added here -->
                </tbody>
            </table>
            
        </div>

        <br>
        <h4>Total Amount: <span id="totalAmount">0</span></h4>
        <button type="button" class="btn btn-success" onclick="submitOrder()">Submit</button>
        <button onclick="closeAddOrderModal()">Close</button>
    </div>
</div>
<br>

<script>
    const selectedProducts = {};
    
    // Function to calculate total amount
    function updateTotalAmount() {
        let totalAmount = 0;
        
        // Loop through all selected products
        Object.keys(selectedProducts).forEach(productId => {
            const product = selectedProducts[productId];
            const quantity = parseInt(document.getElementById(`quantity-${productId}`).value) || 0;
            const smallquantity = parseInt(document.getElementById(`smallquantity-${productId}`).value) || 0;
            const mediumquantity = parseInt(document.getElementById(`mediumquantity-${productId}`).value) || 0;
            const largequantity = parseInt(document.getElementById(`largequantity-${productId}`).value) || 0;
            const xlargequantity = parseInt(document.getElementById(`xlargequantity-${productId}`).value) || 0;

            // Calculate total price for this product
            const totalPrice = (quantity + smallquantity + mediumquantity + largequantity + xlargequantity) * product.price;

            // Update the total price in the table
            const totalPriceCell = document.querySelector(`#selectedProductsTable tbody tr[data-product-id="${productId}"] .total-price`);
            if (totalPriceCell) {
                totalPriceCell.textContent = totalPrice.toFixed(2);
            }

            // Add to overall total amount
            totalAmount += totalPrice;
        });

        // Update the total amount at the top
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
    }

    function submitOrder() {
    const userId = document.getElementById('userId').value; 
    const orderData = {
        userId: userId,
        totalAmount: 0, // Initialize totalAmount
        products: []
    };

    let totalAmount = 0; // Variable to calculate the total amount

    // Gather selected products and their quantities
    Object.keys(selectedProducts).forEach(productId => {
        const product = selectedProducts[productId];
        const price = parseFloat(product.price) || 0; // Assuming product price is available
        const quantity = parseInt(document.getElementById(`quantity-${productId}`).value) || 0;
        const smallquantity = parseInt(document.getElementById(`smallquantity-${productId}`).value) || 0;
        const mediumquantity = parseInt(document.getElementById(`mediumquantity-${productId}`).value) || 0;
        const largequantity = parseInt(document.getElementById(`largequantity-${productId}`).value) || 0;
        const xlargequantity = parseInt(document.getElementById(`xlargequantity-${productId}`).value) || 0;

        // Calculate the total for this product
        const productTotal = price * (quantity + smallquantity + mediumquantity + largequantity + xlargequantity);
        totalAmount += productTotal;

        orderData.products.push({
            productId: productId,
            quantity,
            smallquantity,
            mediumquantity,
            largequantity,
            xlargequantity
        });
    });

    // Set the total amount in orderData
    orderData.totalAmount = totalAmount;

    // Send the order data to the backend
    fetch('https://finalccspayment.onrender.com/api/auth/addorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
        },
        body: JSON.stringify(orderData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Order created successfully') {
            alert(`Success: ${data.message}`);
            window.location.reload(); 
        } else {
            alert(`Error: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error: ${error.message || 'Error creating order'}`);
    });
}


    function fetchProducts() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'adminlogin.html';
            return;
        }

        fetch('https://finalccspayment.onrender.com/api/auth/products', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch products');
            }
            return response.json();
        })
        .then(data => {
            const productResults = document.getElementById('productResults');
            productResults.innerHTML = '';

            if (data.length === 0) {
                productResults.innerHTML = '<p>No products found</p>';
                return;
            }

            data.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.classList.add('product-item');
                productDiv.innerHTML = `
                    <div data-product-id="${product.product_id}">
                        <img src="${product.product_image}" alt="Product Image" style="width: 50px; height: auto;">
                        <p>Name: ${product.name} - Price: ${product.price}</p>
                    </div>
                `;
                productDiv.addEventListener('click', () => toggleProductSelection(product));
                productResults.appendChild(productDiv);
            });
        })
        .catch(error => {
            console.error('Error fetching products:', error);
        });
    }

    function toggleProductSelection(product) {
        const productId = product.product_id;

        if (selectedProducts[productId]) {
            alert("This product has already been selected.");
            return;
        }

        selectedProducts[productId] = { ...product};
        addProductToTable(product);
        highlightSelectedProduct(productId);
    }

    function addProductToTable(product) {
        const tableBody = document.querySelector('#selectedProductsTable tbody');
        const row = document.createElement('tr');
        row.setAttribute('data-product-id', product.product_id);
        row.innerHTML = `
            <td>${product.name}</td>
            <td><input type="number" id="quantity-${product.product_id}" value="0" min="0" class="quantity-input" oninput="updateTotalAmount()"></td>
            <td><input type="number" id="smallquantity-${product.product_id}" value="0" min="0" class="quantity-input" oninput="updateTotalAmount()"></td>
            <td><input type="number" id="mediumquantity-${product.product_id}" value="0" min="0" class="quantity-input" oninput="updateTotalAmount()"></td>
            <td><input type="number" id="largequantity-${product.product_id}" value="0" min="0" class="quantity-input" oninput="updateTotalAmount()"></td>
            <td><input type="number" id="xlargequantity-${product.product_id}" value="0" min="0" class="quantity-input" oninput="updateTotalAmount()"></td>
            <td>${product.price}</td>
            <td class="total-price">${product.price}</td>
            <td><button onclick="removeProduct('${product.product_id}')">Remove</button></td>
        `;
        tableBody.appendChild(row);
    }

    function removeProduct(productId) {
        delete selectedProducts[productId];
        const row = document.querySelector(`#selectedProductsTable tbody tr[data-product-id="${productId}"]`);
        if (row) row.remove();
       
        unhighlightProduct(productId);
        updateTotalAmount();
    }

    function highlightSelectedProduct(productId) {
        const productDiv = document.querySelector(`#productResults div[data-product-id="${productId}"]`);
        if (productDiv) {
            productDiv.classList.add('selected');
        }
    }

    function unhighlightProduct(productId) {
        const productDiv = document.querySelector(`#productResults div[data-product-id="${productId}"]`);
        if (productDiv) {
            productDiv.classList.remove('selected');
        }
    }

    function fetchUsers(query) {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'adminlogin.html';
            return;
        }

        fetch(`https://finalccspayment.onrender.com/api/auth/userspaymentorg?search=${query}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch users');
            }
            return response.json();
        })
        .then(data => {
            const userResults = document.getElementById('userResults');
            userResults.innerHTML = ''; // Clear previous results

            if (data.length === 0) {
                userResults.innerHTML = '<p>No users found</p>';
                return;
            }

            data.forEach(user => {
                if (user.username.toLowerCase().startsWith(query.toLowerCase()) || user.idnumber.toLowerCase().startsWith(query.toLowerCase()) || user.firstname.toLowerCase().startsWith(query.toLowerCase()) || user.lastname.toLowerCase().startsWith(query.toLowerCase()) ||
                user.email.toLowerCase().startsWith(query.toLowerCase())) {
                    const userDiv = document.createElement('div');
                    userDiv.classList.add('user-item');
                    userDiv.innerHTML = `<p>${user.lastname} ${user.firstname}, (${user.idnumber})</p>`;
                    userDiv.addEventListener('click', () => selectUser(user.id, user.username, user.email));
                    userResults.appendChild(userDiv);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching users:', error);
        });
    }

    document.getElementById('userSearch').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length > 0) {
            fetchUsers(query); 
        } else {
            document.getElementById('userResults').innerHTML = ''; 
        }
    });

    function selectUser(userId, username, email) {
        document.getElementById('userId').value = userId; 
        document.getElementById('userSearch').value = `${username} (${email})`; 
        document.getElementById('userResults').innerHTML = ''; 
    }

    function showAddOrderModal() {
        const modal = document.getElementById('addOrderModal');
        modal.style.display = 'block';
        fetchProducts();
    }

    function closeAddOrderModal() {
        const modal = document.getElementById('addOrderModal');
        modal.style.display = 'none';
    }

    
</script>





<div class="main-content">

    
    <div style="display: flex; gap: 10px;margin-top: 20px; margin-left: 20px;">
        <a href="organization-orders.html" style="text-decoration: none;">
          <button style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
            All Orders
          </button>
        </a>
        <a href="organization-ordersManage.html" style="text-decoration: none;">
            <button style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">
            Manage Orders
            </button>
          </a>
        <a href="organization-ordersPaid.html" style="text-decoration: none;">
          <button style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">
            Paid
          </button>
        </a>
        <a href="organization-ordersDecline.html" style="text-decoration: none;">
          <button style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
            Decline
          </button>
        </a>
        <a href="organization-ordersPending.html" style="text-decoration: none;">
          <button style="padding: 10px 20px; background-color: #ffc107; color: rgb(255, 255, 255); border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
            Pending
          </button>
        </a>
      </div>
    <!-- Modal for Add Order -->
   
    <table id="productTransactionsContainer">
        <thead>
            <tr>
                
                <th>Full Name</th>
                <th>Order</th>
                <th>Order Item</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Total Amount</th>
                <th>Total Pay</th>
                <th>Received By</th>
                <th>Created At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="product-transactions-body">
            <!-- Data will be populated here -->
        </tbody>
    </table>
    </div>
</div>
<script>
    // Function to accept the order
function acceptOrder(orderTransactionId) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch(`https://finalccspayment.onrender.com/api/auth/accept-order/${orderTransactionId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        fetchProductTransactions(); // Re-fetch the transactions to update the status
    })
    .catch(error => {
        console.error('Error accepting order:', error);
        alert('Error accepting order');
    });
}

// Function to decline the order
function declineOrder(orderTransactionId) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch(`https://finalccspayment.onrender.com/api/auth/decline-order/${orderTransactionId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        fetchProductTransactions(); // Re-fetch the transactions to update the status
    })
    .catch(error => {
        console.error('Error declining order:', error);
        alert('Error declining order');
    });
}

function fetchProductTransactions() {
    const apiUrl = 'https://finalccspayment.onrender.com/api/auth/product-transactions';
    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        const transactionsBody = document.getElementById('product-transactions-body');
        transactionsBody.innerHTML = ''; // Clear the existing rows before adding new ones

        // Filter data to include only transactions with status "Paid"
        const paidTransactions = data.filter(transaction => transaction.status === 'Paid');

        if (paidTransactions.length === 0) {
            // If no data, add a single row with a "No data available" message
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `
                <td colspan="11" style="text-align: center;">No Paid orders</td>
            `;
            transactionsBody.appendChild(noDataRow);
        } else {
            // If there are paid transactions, display them
            paidTransactions.forEach(transaction => {
                const filterZeroQuantitiesWithLabels = (quantities, label) => {
                    return quantities.split(', ').filter(q => !q.endsWith('0x'))
                        .map(q => `${label} ${q}`).join(', ');
                };

                const smallQuantities = filterZeroQuantitiesWithLabels(transaction.order_smallquantities, 'Small');
                const mediumQuantities = filterZeroQuantitiesWithLabels(transaction.order_mediumquantities, 'Medium');
                const largeQuantities = filterZeroQuantitiesWithLabels(transaction.order_largequantities, 'Large');
                const xLargeQuantities = filterZeroQuantitiesWithLabels(transaction.order_xlargequantities, 'X-Large');
                const orderQuantities = filterZeroQuantitiesWithLabels(transaction.order_quantities, 'Quantity');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.user_firstname} ${transaction.user_lastname}</td>
                    <td>${transaction.order_transaction_id}</td>
                    <td>${transaction.product_names}</td>
                    <td>
                        ${orderQuantities} ${smallQuantities} ${mediumQuantities} ${largeQuantities} ${xLargeQuantities}
                    </td>
                    <td>${transaction.status}</td>
                    <td>${transaction.payment_method}</td>
                    <td>${transaction.total_amount}</td>
                    <td>${transaction.total_pay}</td>
                    <td>
                        ${transaction.accepted_by_firstname && transaction.accepted_by_lastname 
                            ? `${transaction.accepted_by_firstname} ${transaction.accepted_by_lastname}` 
                            : 'There is no receiver yet'}
                    </td>
                    <td>${transaction.created_at}</td>
                    <td>
                          <button 
  onclick="showTransactionLogsModal('${transaction.order_transaction_id}')"
  style="background-color: #007bff; color: white; border: none; border-radius: 5px; padding: 8px; cursor: pointer; font-size: 16px;">
  <i class="fas fa-eye"></i>
</button>
                    </td>
                `;
                transactionsBody.appendChild(row);
            });
        }
    })
    .catch(error => {
        console.error('Error fetching product transactions:', error);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    fetchProductTransactions();
});




    </script>
    
    

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    
</script>

<body>

    <script>
        document.getElementById('logout').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default link behavior
    
            
            localStorage.removeItem('token');
    
            
            window.location.href = 'adminlogin.html';
        });
    </script>
    

   
   
    <script>
        function fetchOrganizationData() {
    const token = localStorage.getItem('token'); // Retrieve token from storage
    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch('https://finalccspayment.onrender.com/api/auth/organization/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.name) {
            
            const infoDiv = document.getElementById('organizationInfo');
            infoDiv.innerHTML = `
             <h2 
    style="color: #25330f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 190px; font-size: 30px; text-transform: uppercase;">
    ${data.name}
</h2>
              
            `;
        } else {
            document.getElementById('organizationInfo').innerText = 'No organization data found.';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('errorMessages').innerText = 'An error occurred. Please try again.';
    });
}


document.addEventListener('DOMContentLoaded', fetchOrganizationData);

    </script>
</body>
</html>
