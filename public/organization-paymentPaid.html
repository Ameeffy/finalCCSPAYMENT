<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link rel="icon" type="x-icon" href="img/logo.png"> <!-- Ensure img/logo.png exists -->
    <title>ORGANIZATION - PAYMENTS</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        background-color: #F5FFFA;
    }

    .top {
            background-color: #F5FFFA;
            position: fixed;
            width: 100%;
            z-index: 0;
            display: flex;
            justify-content: end;
            align-items: center;
            padding-right: 20px;
            z-index: 2;
        }

        .sidebar {
            width: 200px;
            background-color: #F5FFFA; 
            color: rgb(0, 0, 0);
            display: flex;
            flex-direction: column;            
            z-index: 3;            
        }
        .main-content {
            width: 1250px;
            background-color: rgb(221, 231, 221);
            margin-left: 30px;
            height: 600px;
            position: relative; 
            border-radius: 10px;
            height: auto;
            z-index: 1;
        }

    .sidebar .logo {
        padding: 20px;
        text-align: center;
    }

    .sidebar .logo img {
        max-width: 110px;
        height: auto;
    }

    .sidebar .nav-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        color: rgb(0, 0, 0);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .sidebar .nav-item .icon {
        margin-right: 15px;
    }

    .sidebar .nav-item .text {
        font-size: 16px;
    }

    .sidebar .nav-item.active {
        font-weight: bold;
        color: #f1f1f1; /* Light color for contrast */
    }

    .sidebar .nav-item.active .icon {
        color: #f1f1f1; /* Light color for contrast */
    }

    .sidebar .bottom-links {
        margin-top: auto;
        padding: 20px;
        border-top: 1px solid #fff;
    }

    .sidebar .bottom-links .nav-item {
        padding: 10px 20px;
        color: white;
        text-decoration: none;
        
    }

    .sidebar .bottom-links .nav-item:hover {
        background-color: #085d15; /* Slightly darker green */
    }

   
    .spacer {
        flex: 1;
    }

    .full-container {
        display: flex;
        flex-direction: column;
        margin-top: 80px;
        border-radius: 10px;
    }

    h1 {
        font-size: 30px;
       
        font-weight: bold;
        font-family: Arial, Helvetica, sans-serif;
    }
    
    h3 {
        font-size: 20px;
        text-align: right;
        font-weight: bold;
       
    }

    .add-account-btn {
        position: absolute;
        top: 20px;
        left: 20px;
    }

    .set-semester-btn {
        position: absolute;
        top: 20px; 
        right: 20px; 
    }
    .content {
        margin-left: 260px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
   
    table {
width: 97%;
margin: 20px auto; 
border-collapse: separate; 
border-spacing: 0 10px; 
max-width: 100%; 
}

th, td {
 
padding: 8px;
text-align: left;
background-color: #ffffff;
}


th:first-child {
border-top-left-radius: 8px; 
border-bottom-left-radius: 8px; 
}

th:last-child {
border-top-right-radius: 8px; 
border-bottom-right-radius: 8px; 
}


td:first-child {
border-top-left-radius: 8px; 
border-bottom-left-radius: 8px; 
}

td:last-child {
border-top-right-radius: 8px; 
border-bottom-right-radius: 8px; 
}


th {
background-color: #034b03;
color: white;
font-weight: bold;  
font-size: 14px;
}


tr:hover td {
background-color: #ddfadc;

color: black;}

.icon-button {
border: none;
background-color: transparent;
border-radius: 50%;
padding: 10px;
cursor: pointer;
color: #034b03;
transition: background-color 0.3s, transform 0.2s;
}

.icon-button:hover {
background-color: rgba(3, 75, 3, 0.1); 
transform: scale(1.1); 
}


.dropdown-item {
width: 100%;
border: none;
background-color: transparent;
padding: 10px;
text-align: left;
cursor: pointer;
color: #034b03;
transition: background-color 0.3s;
}

.dropdown-item:hover {
background-color: rgba(3, 75, 3, 0.1); 
}


.icon-button:hover + .dropdowns {
display: block; 
}




   


.container {
            display: flex;
        }
      
        .content {
            margin: 10Px auto;
           width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content h1 {
            margin: 0;
            padding: 20px;
            text-align: center;
            font-size: 60px;
        }
        table {
    width: 97%;
    margin: 20px auto; 
    border-collapse: separate; 
    border-spacing: 0 10px; 
    max-width: 100%; 
}

th, td {
     
    padding: 8px;
    text-align: left;
    background-color: #ffffff;
    width: 250px;
}


th:first-child {
    border-top-left-radius: 8px; 
    border-bottom-left-radius: 8px; 
}

th:last-child {
    border-top-right-radius: 8px; 
    border-bottom-right-radius: 8px; 
}


td:first-child {
    border-top-left-radius: 8px; 
    border-bottom-left-radius: 8px; 
}

td:last-child {
    border-top-right-radius: 8px; 
    border-bottom-right-radius: 8px; 
}


th {
    background-color: #034b03;
    color: white;
    font-weight: bold;  
    font-size: 14px;
}

    .status-balance {
        color: rgb(255, 0, 255);
        font-weight: bold;
    }

    .status-pending {
        color: orange;
        font-weight: bold;
    }
    .status-Decline{
        color: rgb(212, 7, 7);
        font-weight: bold;
    }

    .status-paid {
        color: green;
        font-weight: bold;
    }

    @keyframes colorAnimation {
    0% {
        color: rgb(0, 128, 255); /* Start with a blue color */
    }
    50% {
        color: rgb(0, 204, 255); /* Transition to an orange color */
    }
    100% {
        color: rgb(0, 128, 255); /* Transition back to blue */
    }
}

.status-processing {
    font-weight: light;
    animation: colorAnimation 2s infinite; /* Run the animation infinitely with a duration of 2 seconds */
}

        .error {
            color: red;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content-payment {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            width: 35%;
            
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }/* Styles for the payment form */
#paymentForm {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 500px; /* Adjust as needed */
    margin: 0 auto; /* Center the form */
    padding: 20px;
    background-color: rgb(210, 210, 210);
    border-radius: 8px;
    padding-top: 10px;   
}

#paymentForm label {
    font-size: 16px;
    margin-bottom: 8px;
    color: #333;
}

#paymentForm input[type="text"],
#paymentForm input[type="number"] {
    font-size: 16px;
    padding: 8px;
    margin-bottom: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 100%;
}

#paymentForm input[type="text"] {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

#paymentForm input[type="number"] {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

#paymentForm button {
    background-color: #007bff;
    color: white;
    font-size: 16px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 30%;
    justify-content: center;
}

#paymentForm button:hover {
    background-color: #0056b3;
}


#userResults {
    max-height: 100px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fff;
    margin-top: 8px;
    padding: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}


.user-item {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.user-item:hover {
    background-color: #f0f0f0;
}


#errorMessages {
    color: red;
    margin-top: 10px;
}
#transactions-container {
    max-height: 100px; /* Adjust the height as needed */
    overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
    }

  
/* Modal styles */
#transactionHistoryModal {
    position: fixed;
    z-index: 4;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);

}

.modal-content {
    background-color: rgb(221, 231, 221);
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 100%;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5); /* Black background with transparency */
    justify-content: center;
    align-items: center;

}

/* Modal content box */
.modal-content {
    background-color: rgb(221, 231, 221);
    margin-top: 40px;
    padding: 20px;
    width: 100%;
    position: relative;
    max-width: 1100px;
    border-radius: 10px;
}

/* Close button */
.close {
    color: #aaa;
    position: absolute;
    right: 20px;
    top: 0px;
    font-size: 28px;
    font-weight: bold;
}
.closes {
    color: #aaa;
    right: 20px;
    top: 0px;
    font-size: 28px;
    font-weight: bold;
}.closes:hover,
.closes:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.custom-position{
    position: absolute;
    right: 65px;
  margin-top: 20px;
}
.contents{
    width: 95%;
}
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <!-- Logo -->
    <div class="logo">
        <img src="img/logo.png" alt="Logo">
    </div>
    <!-- Navigation Items -->
    <a href="organization-dashboard.html" class="nav-item" id="dashboard-link"  >
        <div class="icon">
            <i class="bi bi-speedometer2"></i> <!-- Updated icon for dashboard -->
        </div>
        <div class="text">Dashboard</div>
    </a>
    <a href="organization-orders.html" class="nav-item" id="orders-link">
        <div class="icon">
            <i class="bi bi-cart"></i> <!-- Updated icon for orders -->
        </div>
        <div class="text">Orders</div>
    </a>
    <a href="organization-payment.html" class="nav-item" id="payment-link" style="background-color: #034b03; color: white;  border-radius: 15px;">
        <div class="icon">
            <i class="bi bi-credit-card"></i> <!-- Updated icon for payment -->
        </div>
        <div class="text" style="font-weight: bold;">Payment</div>
    </a>
    <a href="organization-products.html" class="nav-item" id="products-link">
        <div class="icon">
            <i class="bi bi-box-seam"></i> <!-- Updated icon for products -->
        </div>
        <div class="text">Products</div>
    </a>
    <a href="organization-masterlist.html" class="nav-item" id="masterlist-link">
        <div class="icon">
            <i class="bi bi-list-task"></i> <!-- Updated icon for masterlist -->
        </div>
        <div class="text">Masterlist</div>
    </a>
   
</div>




<div class="top d-flex justify-content-end align-items-center p-2">
    <div id="organizationInfo" class="d-flex flex-grow-1">
        
    </div>
    
    <i style="margin-right: 20px;">
        <li id="profile-item" class="dropdown-item">
            <a href="#">Loading...</a>
        </li>
    </i>
    <div class="dropdownsss">
        <a href="#" class="d-flex align-items-center text-decoration-none"  id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            
            <i class="fas fa-user-circle fa-2x" style="color: #25330f;"></i>
           
            <i class="fas fa-caret-down ms-2" style="color: #25330f;"></i>

            

        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            

            <li><a class="dropdown-item" href="#" id="logout">Sign Out</a></li>
        </ul>
    </div>
</div>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

<!-- DataTables Buttons Extension CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css">

<!-- jQuery -->
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<!-- DataTables Buttons Extension JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>

<!-- JSZip (required for Excel export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<!-- PDFMake (required for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<!-- Buttons for Excel, PDF, Print, and CSV -->
<script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.print.min.js"></script>


    <script>
    
    function fetchLoggedInUserDetails() {
    const token = localStorage.getItem('token'); // Retrieve the token from localStorage

    if (!token) {
        window.location.href = 'adminlogin.html'; // Redirect to login if no token
        return;
    }

    fetch('http://localhost:5000/api/auth/organization-user/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(user => {
        if (!user) {
            throw new Error('User not found');
        }
        
        
        const fullName = `${user.firstname} ${user.lastname}`; 

        document.getElementById('profile-item').innerHTML = `
           <a style="color: #25330f; text-decoration: none; " href="organization-users-info.html">
   
    <h3 style="font-style: normal;">${user.firstname} ${user.lastname}</h3>
</a>

        `;
    })
    .catch(error => {
        console.error('Error fetching organization user details:', error);
        document.getElementById('profile-item').innerHTML = '<a href="#">Error loading profile</a>';
    });
}

// Call the function when the DOM is loaded
document.addEventListener('DOMContentLoaded', fetchLoggedInUserDetails);
        document.getElementById('logout').addEventListener('click', function(event) {
            event.preventDefault();
    
           
            localStorage.removeItem('token');
    
            
            window.location.href = 'adminlogin.html';
        });
    </script>
<div class="full-container">
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center" style="margin-top: 20px; margin-bottom: 20px; padding-right: 20px;">
            <!-- Left-aligned search -->
            <div class="search-container d-flex align-items-center" style="margin-left: 10px;">
                <form class="form-inline" onsubmit="event.preventDefault();">
                    <input class="form-control" type="search" placeholder="Search Semesters" aria-label="Search" id="searchInput" oninput="searchSemester()">
                    <i style="margin-left: 5px;" class="bi bi-search"></i>
                </form>
            </div>
        
            <!-- Right-aligned Add Payment button and text, aligned vertically -->
            <div class="d-flex flex-column align-items-center">
               
            </div>
        </div>
        <div class="content">
            <div class="contents">     
            </div>
        </div>
    </div>
</div>


      

<div id="transactionHistoryModal" style="display: none;">
    <div class="modal-content">
        <span style="position: absolute; right: 20px; cursor: pointer; margin-top: 20px;" class="close" onclick="closeTransactionModalHistory()">
            <i class="fas fa-times-circle"></i>
        </span>
        <div id="transactionHistoryDetails"></div>
    </div>
</div>

<script>
       function fetchOrganizationData() {
    const token = localStorage.getItem('token'); // Retrieve token from storage
    if (!token) {
        window.location.href = 'organization-login.html'; // Redirect to login if no token
        return;
    }

    fetch('http://localhost:5000/api/auth/organization/details', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.name) {
            // Display organization data
            const infoDiv = document.getElementById('organizationInfo');
            infoDiv.innerHTML = `
              
    <h2 style="color: #25330f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 220px">
        ${data.name}
    </h2>
</div>

              
            `;
        } else {
            document.getElementById('organizationInfo').innerText = 'No organization data found.';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('errorMessages').innerText = 'An error occurred. Please try again.';
    });
}


document.addEventListener('DOMContentLoaded', fetchOrganizationData);

    function openTransactionModalHistory(transactionId) {
    
    document.getElementById('transactionHistoryModal').style.display = 'block';
    
    fetch(`http://localhost:5000/api/auth/transaction-history/${transactionId}`)
    .then(response => response.json())
    .then(data => {
        const historyDetails = document.getElementById('transactionHistoryDetails');
        historyDetails.innerHTML = '';

        
        const heading = `<h2>Transaction History of ID: ${transactionId}</h2>`;
        historyDetails.innerHTML += heading;

        
        data.forEach(tx => {
            
            const showPromissoryNote = tx.promissory_note && tx.promissory_note.trim() !== '';
            
            
            let statusColor;
            if (tx.payment_status === "Balance") {
                statusColor = 'red';
            } else if (tx.payment_status === "Pending") {
                statusColor = 'orange';
            } else if (tx.payment_status === "Paid") {
                statusColor = 'green';
            } else {
                statusColor = 'black'; 
            }

            const detailTable = `
                <div style="margin-bottom: 20px;">
                    <p style="margin-bottom: 10px;">${new Date(tx.created_at).toLocaleString()}</p>
                    <table>
                        <thead>
                            <tr>
                                
                                <th>Payment Method</th>
                                <th>Total Amount</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Received by</th>
                                <th>Action</th>
                                ${showPromissoryNote ? '<th>Promissory Note</th>' : ''}
                                
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                               
                                <td>${tx.payment_method}</td>
                                <td>₱ ${tx.total_amount}</td>
                                <td>₱ ${tx.balance}</td>
                                 <td style="color: ${statusColor}; font-weight: light;">${tx.payment_status}</td>
                                 <td>
  ${tx.received_firstname && tx.received_lastname ? `${tx.received_firstname} ${tx.received_lastname}` : 'There is no receiver'}
</td>
                                <td>${tx.action ? tx.action : 'N/A'}</td>

                                ${showPromissoryNote ? `<td>${tx.promissory_note}</td>` : ''}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            historyDetails.innerHTML += detailTable;
        });
    })
    .catch(error => console.error('Error fetching transaction history:', error));
}

function closeTransactionModalHistory() {
    // Hide the modal
    document.getElementById('transactionHistoryModal').style.display = 'none';
}

</script>


    <script>
       
    
        let allSemesterData = []; // Store all semester data for filtering
let filteredSemesterData = []; // Store filtered semester data based on search
let currentSemesterIndex = 0; // Track the current index of semesters displayed

function fetchPaymentsBySemester() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'adminlogin.html';
        return;
    }

    fetch('http://localhost:5000/api/auth/payments/by-semesterorganization', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch payments');
        }
        return response.json();
    })
    .then(data => {
        const content = document.querySelector('.contents');
        content.innerHTML = ''; // Clear previous content
        if (data.length === 0) {
            document.getElementById('errorMessages').innerText = 'No payments found for any semester.';
            return;
        }

        allSemesterData = data; // Store all data for search functionality
        filteredSemesterData = data; // Initialize filtered data to all data
        currentSemesterIndex = 0; // Reset index on fetch

        // Display only the first semester
        renderSemester(data[0], content);

        // Scroll to the first semester on load (not strictly necessary as it will be displayed)
        const semesterId = `semester-${data[0].semester.replace(/\s+/g, '-')}`;
        const firstSemesterElement = document.getElementById(semesterId);
        if (firstSemesterElement) {
            firstSemesterElement.scrollIntoView({ behavior: 'smooth' });
        }
    })
    .catch(error => {
        console.error('Error fetching payments:', error);
        document.getElementById('errorMessages').innerText = 'An error occurred while fetching payments. Please try again later.';
    });
}

function renderSemester(semesterData, content) { 
    const semesterId = `semester-${semesterData.semester.replace(/\s+/g, '-')}`;
    const semesterSection = document.createElement('div');
    semesterSection.id = semesterId; // Set an ID for scrolling purposes

    // Display the semester title
    semesterSection.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: auto;">
    <!-- Semester Title on the Left -->
    <h2 style="cursor: pointer; text-align: left; font-weight: bold; margin-right: 20px;">
        ${semesterData.semester}
    </h2>

    <!-- Up and Down Icons on the Right, aligned vertically -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <!-- Up Icon -->
        <button onclick="showPreviousSemester()" style="background: none; border: none; cursor: pointer;" 
            ${currentSemesterIndex === 0 ? 'disabled' : ''}>
            <i class="fas fa-chevron-up" style="font-size: 24px;"></i>
        </button>
        <!-- Down Icon -->
        <button onclick="showNextSemester()" style="background: none; border: none; cursor: pointer;" 
            ${currentSemesterIndex === filteredSemesterData.length - 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-down" style="font-size: 24px;"></i>
        </button>
    </div>
</div>


        <br>
    `;
    content.appendChild(semesterSection);

    if (semesterData.payments.length > 0) {
        semesterData.payments.forEach(payment => {
            const paymentSection = document.createElement('div');
            paymentSection.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center;">
                    <div class="d-flex align-items-center">
                        <h4>Payment Name: ${payment.name} ₱ ${payment.price} <br></h4>
                        <div style="text-align: right;">
                           
                        </div>
                    </div>
                </div>
                <div id="transactions-${payment.id}" data-content="no-data">
                    <p>No transactions available.</p>
                </div>
                <br><br>
            `;
            content.appendChild(paymentSection);

            // Fetch transactions for each payment
            fetchTransactionsByPaymentId(payment.id);
            setInterval(() => {
                fetchTransactionsByPaymentId(payment.id);
            }, 15000);
        });
    } else {
        const noPaymentMessage = document.createElement('p');
        noPaymentMessage.innerText = 'No payment during this semester.';
        content.appendChild(noPaymentMessage);
    }
}

// Function to show the next semester
function showNextSemester() {
    if (currentSemesterIndex < filteredSemesterData.length - 1) {
        currentSemesterIndex++;
        updateSemesterDisplay();
    }
}

// Function to show the previous semester
function showPreviousSemester() {
    if (currentSemesterIndex > 0) {
        currentSemesterIndex--;
        updateSemesterDisplay();
    }
}

// Function to update the displayed semester
function updateSemesterDisplay() {
    const content = document.querySelector('.contents');
    content.innerHTML = ''; // Clear previous content
    const semesterData = filteredSemesterData[currentSemesterIndex]; // Get the current semester data from filtered data
    renderSemester(semesterData, content); // Render the current semester
}

function searchSemester() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filter the stored data based on the search term
    filteredSemesterData = allSemesterData.filter(semester => 
        semester.semester.toLowerCase().includes(searchTerm)
    );

    currentSemesterIndex = 0; // Reset index when searching
    updateSemesterDisplay(); // Update the display with filtered semesters

    const content = document.querySelector('.contents');
    if (filteredSemesterData.length > 0) {
        // Scroll to the first matching semester
        const firstMatch = filteredSemesterData[0];
        const semesterId = `semester-${firstMatch.semester.replace(/\s+/g, '-')}`;
        const semesterElement = document.getElementById(semesterId);
        if (semesterElement) {
            semesterElement.scrollIntoView({ behavior: 'smooth' });
        }
    } else {
        content.innerHTML = '<p>No matching semesters found.</p>';
    }
}




function fetchTransactionsByPaymentId(paymentId) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'adminlogin.html';
        return;
    }

    fetch(`http://localhost:5000/api/auth/transactions/${paymentId}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch transactions');
        }
        return response.json();
    })
    .then(transactions => {
        const transactionsContainer = document.getElementById(`transactions-${paymentId}`);
        
        if (!transactionsContainer) {
            console.error('Transactions container element not found.');
            return;
        }

        // Clear any previous content
        transactionsContainer.innerHTML = '';

        // Filter transactions to show only those with "Paid" status
        const paidTransactions = transactions.filter(tx => tx.payment_status === 'Paid');

        // Check if there are paid transactions
        if (paidTransactions.length === 0) {
            transactionsContainer.innerHTML = '<p>No paid transactions available.</p>';
            return; // Exit if no paid transactions
        }

        // Determine if there are any promissory notes
        const hasPromissoryNotes = paidTransactions.some(tx => tx.promissory_note && tx.promissory_note.trim() !== '');

        const table = document.createElement('table');
        table.id = `transactionsTable-${paymentId}`;
        table.className = 'display';  // DataTables requires 'display' class

        table.innerHTML = `
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Student Name</th>
                    <th>Payment Method</th>
                    <th>Total Amount</th>
                    <th>Balance</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Received by</th>
                    ${hasPromissoryNotes ? '<th>Promissory Notes</th>' : ''}
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
    ${paidTransactions.map(tx => {
        let statusClass;
        switch (tx.payment_status) {
            case "Balance":
                statusClass = 'status-balance';
                break;
            case "Pending":
                statusClass = 'status-pending';
                break;
            case "Paid":
                statusClass = 'status-paid';
                break;
            case "Processing":
                statusClass = 'status-processing';
                break;
            case "Decline":
                statusClass = 'status-decline';
                break;
            default:
                statusClass = ''; 
        }

        const showDeclineButton = tx.payment_status === 'Pending' && tx.payment_method === 'Gcash' && tx.total_amount <= 0;
        const showAddAmountButton = tx.payment_status === 'Processing' && tx.total_amount <= 0;

        return `
            <tr>
                <td>${tx.transaction_id}</td>
                <td>${tx.user_firstname} ${tx.user_lastname}</td>
                <td>
                    ${tx.payment_method === 'Gcash' ? `
                        ${tx.payment_method} <br>
                        <button onclick="openGcashModal('${tx.transaction_id}')" class="btn btn-secondary">
                            <i class="bi bi-eye"></i> <!-- Bootstrap Eye Icon for 'View' -->
                        </button>

                        <div id="qrgcash-${tx.transaction_id}" class="modal" style="display:none;">
                            <div class="modal-content">
                                <span class="close" onclick="closeGcashModal('${tx.transaction_id}')">&times;</span>
                                <img src="${tx.proof_of_payment}" alt="Proof of Payment" style="width: 100%; height: auto;" />
                            </div>
                        </div>
                    ` : tx.payment_method}
                </td>
                <td>₱ ${tx.total_amount}</td>
                <td>₱ ${tx.balance}</td>
                <td>${new Date(tx.updated_at).toLocaleString()}</td>
                <td class="${statusClass}">${tx.payment_status}</td>
                <td>
                    ${tx.received_firstname && tx.received_lastname ? `${tx.received_firstname} ${tx.received_lastname}` : 'There is no receiver yet'}
                </td>
                ${hasPromissoryNotes ? `<td>${tx.promissory_note || 'N/A'}</td>` : ''}
                <td>
                    ${tx.payment_status === 'Balance' || tx.payment_status === 'Paid' || tx.payment_status === 'Processing' ? `
                        <button onclick="openTransactionModalHistory('${tx.transaction_id}')" class="btn btn-secondary" style="padding: 5px 10px;">
                            <i class="bi bi-clock-history" style="font-size: 18px;"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    }).join('')}
</tbody>
        `;

        transactionsContainer.appendChild(table);

        // Initialize DataTables on the created table and sort by the Date column (index 5) in descending order
        $(`#transactionsTable-${paymentId}`).DataTable({
            dom: 'Blfrtip', // Adds length menu (`l`), buttons (`B`), filter (`f`), and other elements
            buttons: [
                {
                    extend: 'copy',
                    text: '<i class="fas fa-copy" style="color: #007bff;"></i>', // Blue for Copy
                    titleAttr: 'Copy'
                },
                {
                    extend: 'csv',
                    text: '<i class="fas fa-file-csv" style="color: #28a745;"></i>', // Green for CSV
                    titleAttr: 'Export to CSV'
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel" style="color: #1c7430;"></i>', // Dark Green for Excel
                    titleAttr: 'Export to Excel'
                },
                {
                    extend: 'pdf',
                    text: '<i class="fas fa-file-pdf" style="color: #dc3545;"></i>', // Red for PDF
                    titleAttr: 'Export to PDF'
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print" style="color: #6c757d;"></i>', // Gray for Print
                    titleAttr: 'Print'
                }
            ],
            order: [[5, 'desc']],  // Sort by Date column (index 5) in descending order
            lengthMenu: [10, 25, 50, 100]  // Options for "Show entries" dropdown
        });
    })
    .catch(error => console.error('Error fetching transactions:', error));
}




function openGcashModal(transactionId) {
    document.getElementById(`qrgcash-${transactionId}`).style.display = 'block';
}

function closeGcashModal(transactionId) {
    document.getElementById(`qrgcash-${transactionId}`).style.display = 'none';
}







        fetchPaymentsBySemester();
    </script>
    
</body>
</html>
